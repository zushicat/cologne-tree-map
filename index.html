<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <!-- empty cache -->
    <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="shortcut icon" href="src/tree_favicon.png">

    <!-- mapbox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css' rel='stylesheet' />

    <!-- mapbox geocoder -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css"/>
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>


    <!-- <script src="lib/dom-to-image.min.js"></script> -->
    <script src="lib/echarts.min.js"></script>
    <script src="lib/jquery-3.3.1.min.js"></script>
    <!-- <script src="lib/js.cookie.min.js"></script> -->

    <!-- onsen -->
    <link rel="stylesheet" href="lib/OnsenUI-dist-2.10.10/css/onsenui.css">
    <link rel="stylesheet" href="lib/OnsenUI-dist-2.10.10/css/onsen-css-components.min.css">
    <script src="lib/OnsenUI-dist-2.10.10/js/onsenui.min.js"></script>
 
    <!-- jszip -->
    <!-- https://stuk.github.io/jszip/ -->
    <script src="lib/jszip/jszip.min.js"></script>
    <script src="lib/jszip/jszip-utils.min.js"></script>

    <!-- ! TMP ! client-sided utm -> lat/lng projection -->
    <!-- https://stackoverflow.com/a/18621244 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>

    <style>
        /* ************************** */
        /* page */
        /* ************************** */
        body
        {
            font-weight: 400;
            font-size: 17px;
            line-height: 32px;
        }
        .page__background { background-color: #fff; }

        /* ************************** */
        /* content container */
        /* ************************** */
        .content_container { margin: 20px; }

        /* ************************** */
        /* map */
        /* ************************** */
        #tree_map {
            width: 100%;
            height: 500px;
            background-color: #ccc;
        }

        .legend {
            background-color: #fff;
            border-radius: 3px;
            bottom: 30px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            padding: 10px;
            position: absolute;
            right: 10px;
            z-index: 1;
        }
        
        .legend h4 {
            margin: 0 0 10px;
        }
        
        .legend div span, .bulletpoints div span {
            border-radius: 50%;
            display: inline-block;
            height: 10px;
            margin-right: 5px;
            width: 10px;
        }

        /* ************************** */
        /* widgets */
        /* ************************** */
        .widget-head {
            font-size: x-large;
            font-weight: bold;
        }

        .widget-content {
            padding-top: 20px;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }

        .half_page_width, .full_page_width {
            width: 800px;
            height: 800px;
        }

        .echart_col {
            text-align: -webkit-center;
        } 

        canvas {
            margin: 0 auto;  /* center echart canvas in div */
        }
    </style>
</head>

<body>
    <!-- ************************************* -->
    <!-- modal on init -->
    <!-- ************************************* -->
    <ons-modal direction="up" style="background-color: #aaa;">
        <div style="text-align: center">
            <ons-icon icon="md-spinner" size="60px" spin></ons-icon>
            <p>Loading tree data for map...</p>
        </div>
    </ons-modal>

    <!-- ************************************* -->
    <!-- start navigator -->
    <!-- ************************************* -->
    <ons-navigator id="myNavigator" page="home_splitter.html"></ons-navigator>
    <!-- <ons-navigator id="myNavigator" page="district_page.html"></ons-navigator> -->
    
    <!-- ************************************* -->
    <!-- home_splitter: menu and venue_list -->
    <!-- ************************************* -->
    <template id="home_splitter.html">
        <ons-page id="home_splitter">
            <ons-splitter>
                <ons-splitter-side id="side_menu" page="menu.html" side="left" width="80%" collapse></ons-splitter-side>
                <ons-splitter-content id="content" page="map_page.html"></ons-splitter-content>
            </ons-splitter>
        </ons-page>
    </template>

    <!-- ************************************* -->
    <!-- side menu -> map navigation -->
    <!-- ************************************* -->
    <template id="menu.html">
        <ons-page id="menu">
            <!-- ********************** -->
            <!--  map navigation  -->
            <!-- ********************** -->
            <div class="content_container" id="map_interaction_container">
                <p class="widget-head">Tree map display options</p>
                <ons-list>
                    <!-- ***** -->
                    <!-- age group -->
                    <!-- ***** -->
                    <ons-list-item tappable>
                        <ons-row>
                            <ons-col>
                                <p>Select age groups of trees</p>
                            </ons-col>
                        </ons-row>

                        <ons-row>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="0" class="nav_age_group_checkbox" input-id="nav_filter_age_group_0" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_0" class="center">
                                    <= 25 years
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="1" class="nav_age_group_checkbox" input-id="nav_filter_age_group_1" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_1" class="center">
                                    26-40 years
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="2" class="nav_age_group_checkbox" input-id="nav_filter_age_group_2" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_2" class="center">
                                    > 40 years
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="3" class="nav_age_group_checkbox" input-id="nav_filter_age_group_3" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_3" class="center">
                                    unknown
                                </label>
                            </ons-col>
                            <ons-col width="200px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="-1" class="nav_age_group_checkbox" input-id="nav_filter_age_group_4" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_4" class="center">
                                    Cut down trees
                                </label>
                            </ons-col>
                        </ons-row>
                    </ons-list-item>

                    <!-- ***** -->
                    <!-- map / satellite / suburb borders -->
                    <!-- ***** -->
                    <ons-list-item>
                        <ons-row>
                            <ons-col>
                                <p>Display options</p>
                            </ons-col>
                        </ons-row>

                        <ons-row>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-radio name="nav_switch_map_style" value="streets" input-id="nav_switch_map_style_streets" checked></ons-radio>
                                    Streets
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-radio name="nav_switch_map_style" value="satellite" input-id="nav_switch_map_style_satellite"></ons-radio>
                                    Satellite
                                </label>
                            </ons-col>
                            <ons-col width="200px">
                                <label class="left">
                                    <ons-checkbox input-id="nav_show_district_borders" checked></ons-checkbox>
                                </label>
                                <label for="nav_show_district_borders" class="center">
                                    Show suburb borders
                                </label>
                            </ons-col>
                        </ons-row>
                    </ons-list-item>

                    <!-- ***** -->
                    <!-- location type -->
                    <!-- ***** -->
                    <ons-list-item tappable>
                        <ons-row>
                            <ons-col>
                                <p>Select location types</p>
                            </ons-col>
                        </ons-row>

                        <ons-row>
                            <ons-col width="250px">
                                <label class="left">
                                    <ons-checkbox data-locationtype="green_spaces_agriculture" class="nav_location_type_checkbox" input-id="nav_location_type_checkbox_0" checked></ons-checkbox>
                                </label>
                                <label for="nav_location_type_checkbox_0" class="center">
                                    Green spaces agriculture
                                </label>
                            </ons-col>
                            <ons-col width="250px">
                                <label class="left">
                                    <ons-checkbox data-locationtype="green_spaces_leisure" class="nav_location_type_checkbox" input-id="nav_location_type_checkbox_1" checked></ons-checkbox>
                                </label>
                                <label for="nav_location_type_checkbox_1" class="center">
                                    Green spaces leisure
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-locationtype="highway" class="nav_location_type_checkbox" input-id="nav_location_type_checkbox_2" checked></ons-checkbox>
                                </label>
                                <label for="nav_location_type_checkbox_2" class="center">
                                    Highway
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-locationtype="unknown" class="nav_location_type_checkbox" input-id="nav_location_type_checkbox_3" checked></ons-checkbox>
                                </label>
                                <label for="nav_location_type_checkbox_3" class="center">
                                    unknown
                                </label>
                            </ons-col>
                        </ons-row>
                    </ons-list-item>

                    <!-- ***** -->
                    <!-- <ons-list-item id="nav_district_button_list_container" tappable expandable>
                        Show trees in selected districts
                        <div class="expandable-content"> -->
                            <!-- dynamically created district list as 3x3 grid: build_district_selection_grid() -->
                            <!-- hardcoded in fct: start with restricted tree display of Innenstadt and Ehrendfeld -->
                            <!-- <ons-row id="nav_selected_districts_container"></ons-row> -->
                        <!-- </div>
                    </ons-list-item> -->

                    <!-- ***** -->
                    <!-- districts -->
                    <!-- ***** -->
                    <ons-list-item>
                        <ons-row>
                            <ons-col>
                                <p>Select districts with displayed trees</p>
                            </ons-col>
                        </ons-row>

                        <ons-row id="nav_selected_districts_container">
                        </ons-row>
                    </ons-list-item>
                </ons-list>
            </div>

            <div>
                <ons-row>
                    <ons-col style="text-align: center;">
                        <ons-button id="menu_ok_button">OK</ons-button>
                    </ons-col>
                </ons-row>
            </div>
        </ons-page>
    </template>

    
    <!-- ************************************* -->
    <!-- main / start / map page -->
    <!-- ************************************* -->
    <template id="map_page.html">
        <ons-page id="map_page">
            <ons-toolbar>
                <!-- <div class="left">
                    <ons-toolbar-button onclick="fn.open()">
                        <ons-icon icon="md-menu"></ons-icon>
                    </ons-toolbar-button>
                    Map Options
                </div> -->
                <div class="center">
                    Cologne Tree Inventory Insights
                </div>
            </ons-toolbar>

            <!-- ********************** -->
            <!-- the map with map options button -->
            <!-- ********************** -->
            <div id="tree_map">
                <!-- ***** -->
                <!-- legend -->
                <!-- ***** -->
                <div id="state-legend" class="legend">
                    <h5>Age of trees</h5>
                    <div><span style="background-color: #c3eb34"></span>&lt;= 25 years</div>
                    <div><span style="background-color: #7aeb34"></span>26 - 40 years</div>
                    <div><span style="background-color: #2ed93c"></span>&gt; 40 years</div>
                    <div><span style="background-color: #4f96c9"></span>unknown</div>

                    <div style="margin-top: 10px;">
                        <span style="background-color: #ff0000"></span>presumed cut down
                    </div>

                    <div style="
                    margin-top: 20px;
                    padding: 3px;
                    border: 1px solid #ccc;
                    border-radius: 5px;
                    cursor: pointer;" onclick="fn.open()">
                        <ons-icon icon="fa-cog" size="20px" style="
                        font-size: 20px;
                        background-color: #b9b9b9;
                        padding: 5px;
                        border-radius: 105px;
                        color: #525252;
                        "></ons-icon>
                        <span style="margin-left: 5px; width: 150px;">Modify map display</span>
                    </div>

                    <div style="margin-top: 20px; max-width: 200px;">
                        For details about individual trees, please click on the respective tree markers.
                    </div>
                </div>

                <!-- ***** -->
                <!-- currently displayed districts -->
                <!-- ***** -->
                <div class="legend" style="
                left: 10px;
                top: 10px;
                right: auto;
                bottom: auto;
                ">
                    <h5>Currently displayed districts</h5>
                    <ul id="map_info_displayed_districts">
                        <li>Innenstadt</li>
                    </ul>
                    <h5>Currently displayed location types</h5>
                    <ul id="map_info_displayed_location_type">
                        <li>green spaces agriculture</li>
                        <li>green spaces leisure</li>
                        <li>highway</li>
                        <li>unknown</li>
                    </ul>
                    <div style="margin-top: 5px; max-width: 250px;">Please modify map display for showing trees in different districts.</div>
                </div>
            </div>

            
            
            <!-- ********************** -->
            <!-- content -->
            <!-- ********************** -->
            <div class="content_container">
                <!-- ********************** -->
                <!-- some explanation -->
                <!-- ********************** -->
                <p>
                    Visualization of Cologne Tree Data. <b>As of now, this is work in progress.</b>
                    <br><br>
                    This visualization uses heavily modified and enriched data derived from the official "Baumkataster" tree inventory datasets for 2017 and 2020, published by
                    Stadt Köln under Creative Commons Namensnennung 3.0 DE in <a href="https://offenedaten-koeln.de/dataset/baumkataster-koeln" target="_blank">https://offenedaten-koeln.de/dataset/baumkataster-koeln</a>
                    <br>
                    Please refer to <a href="https://zushicat.github.io/cologne-trees-static-API" target="_blank">https://zushicat.github.io/cologne-trees-static-API</a> 
                    and <a href="https://github.com/zushicat/cologne-trees-data" target="_blank">https://github.com/zushicat/cologne-trees-data</a>
                    for detailled information about the data enrichment process and the accumulation of the underlaying data.
                    <br><br>
                    <b>Please note:</b><br>
                    Both Cologne "Baumkataster" tree inventory datasets are obviously far from being a complete depiction of the tree distribution throughout the city.<br>
                    For a quick illustration, please change to "satellite" display in the map options, zoom in at any point and compare the rendered 
                    tree datapoints with trees that you can identify on the satelite image. 
                    (The satellite images are not necessarily up to date. Please refer to this <a href="https://www.mapbox.com/maps/satellite" taget="_blank">mapbox documentation</a>.)
                    <br><br>
                    <b>Overcoming the dataset limitations</b><br>
                    A separate machine learning project for object detection on orthographic images, or more specificially: tree crown detection on urban landscapes, 
                    (based on this model <a href="https://deepforest.readthedocs.io/en/latest/index.html" target="_blank">https://deepforest.readthedocs.io</a>)
                    is in developement right now and should be publicy available soon.<br>
                    So far, this method of tree detection showed great initial results and will be a tremendous step forward to depict the real situation of 
                    tree distribution throughout the city.<br>
                    The according results resp. the repository link will be published here as soon as possible.
                    <br><br>
                    <b>Please keep in mind</b> that this visualization as of now only reflects the tree distribution
                     as derived from the official inventories, hence it shows what is counted and not necessarily what is real.
                </p>

                <!-- ******************************************** -->
                <!-- overview charts -->
                <!-- ******************************************** -->

                <!-- ********************** -->
                <!-- age by genus / base_info vs. regression -->
                <!-- ********************** -->
                <!-- <div class="widget-content">
                    <p class="widget-head">age data comparison</p>
                    <p>age by genus / base_info vs. regression</p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Bla</p>
                            <div id="overview_age_gt_regression" class="echart full_page_width"></div>
                        </ons-col>
                    </ons-row>
                </div> -->

                <!-- ********************** -->
                <!-- overall existing / data completeness -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Overall Numbers</p>
                    <p>Dataset Overview</p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Tree Existence In Datasets</p>
                            <div id="overview_tree_count" class="echart half_page_width"></div>
                            
                            <!-- map percentage in text -->
                            <p style="text-align: left;">
                                <b><span id="overview_number_cut_down"></span> (<span id="overview_percentage_cut_down"></span>%)</b> of trees in Cologne are presumably cut down between 2017 and 2020.<br>
                                Those trees appear in the 2017 dataset but not in the 2020 dataset, assuming they were actively taken out of the inventory 
                                due to the fact they are no longer existing.<br><br>
                                <b>Please note</b> the 
                                <a href="https://github.com/zushicat/cologne-trees-data/blob/master/dataschema.md">explanation of the merging process</a>
                                for both datasets (first note on top of the page), trying to eliminate double entries by proximity check.<br>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/meta/overall_tree_count.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Mean Data Completeness</p>
                            <div id="overview_data_completeness" class="echart half_page_width"></div>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/meta/data_completeness.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                    </ons-row>
                </div>

                <!-- ********************** -->
                <!-- object type -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Distribution by Object Types</p>
                    <p>In which environment are trees located according to the official tree inventories?</p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Existing trees</p>
                            <div id="overview_object_type_tree_count" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees</p>
                            <div id="overview_object_type_cut_tree_count" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Distribution in %</p>
                            <div id="overview_object_type_tree_count_perc" class="echart half_page_width"></div>
                            
                            <!-- map percentage in text -->
                            <div style="text-align: -webkit-left;">
                                <p>
                                    The data reflects a strong bias towards cataloguing trees of following object types:
                                    <ul>
                                        <li>building/school/dormitory (home) building</li>
                                        <li>street/court (plaza)</li>
                                    </ul>
                                    whereas object types which could be summarized under parks & recreation are under-represented. <br>
                                    <b>But</b> random samples also show that many trees in such surroundings are wrongly categorized as 
                                    "building/school/dormitory (home) building" (or not at all), hence these findings should be considered
                                    as highly unreliable.<br><br>
                                    Please compare: OpenStreepMap matches of tree geolocations in the next section.
                                    <br><br>
                                    <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/object_type/tree_count.json" target="_blank">[JSON data]</a>
                                </p>
                            </div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Distribution in %</p>
                            <div id="overview_object_type_cut_tree_count_perc" class="echart half_page_width"></div>
                            
                            <!-- map percentage in text -->
                            <div style="text-align: -webkit-left;">
                                <p>
                                    In contrast, the object types 
                                    <ul>
                                        <li>street/court (plaza)</li>
                                        <li>unknown</li>
                                    </ul>
                                    have a significant share within the data of (presumably) cut down trees with felled
                                    trees in street surroundings with approx. half of the share clearly in top position.<br>
                                    <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/object_type/cut_tree_count.json" target="_blank">[JSON data]</a>
                                </p>
                            </div>
                        </ons-col>
                    </ons-row>
                </div>

                <!-- ********************** -->
                <!-- location type -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Distribution by Location Types</p>
                    <p>
                        In which environment are trees located according to a geolocation match with OpenStreetMap data?
                        <br>
                        For details regarding the naming conventions, please refer to 
                        <a href="https://github.com/zushicat/cologne-trees-data/blob/master/dataschema.md" taget="_blank">dataschema.md</a> (section: tree_location_type).
                    </p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Existing trees by broad categories</p>
                            <div id="overview_location_type_tree_count" class="echart half_page_width"></div>
                            
                            <!-- map percentage in text -->
                            <div style="text-align: -webkit-left;">
                                <p>
                                    <b>Please note</b><br>
                                    Here, "unknown" means: a tree nether intersects a polygon (broadly) defined as green space, nor a (buffered) polygon of any highway.<br>
                                    These trees are rather "undefined" since another layer (derived from OSM) could be introduced in the future.<br><br>

                                    <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/location_type/tree_count_location_type.json" target="_blank">[JSON data]</a>
                                </p>
                            </div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees by broad categories</p>
                            <div id="overview_location_type_cut_tree_count" class="echart half_page_width"></div>
                            <p><a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/location_type/cut_tree_count_location_type.json" target="_blank">[JSON data]</a></p>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Existing trees: Detailled green space environment</p>
                            <div id="overview_location_type_tree_count_osm_key" class="echart half_page_width"></div>
                            <p><a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/location_type/tree_count_osm_keys.json" target="_blank">[JSON data]</a></p>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees:  Detailled green space environment</p>
                            <div id="overview_location_type_cut_tree_count_osm_key" class="echart half_page_width"></div>
                            <p><a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/location_type/cut_tree_count_osm_keys.json" target="_blank">[JSON data]</a></p>
                        </ons-col>
                    </ons-row>
                </div>

                <!-- ********************** -->
                <!-- age groups -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Age groups</p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Existing trees</p>
                            <div id="overview_agegroups_tree_count" class="echart half_page_width"></div>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/agegroups/tree_count_with_predictions.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees</p>
                            <div id="overview_agegroups_cut_tree_count" class="echart half_page_width"></div>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/agegroups/cut_tree_count_with_predictions.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                    </ons-row>
                    <p style="text-align: left;">
                        The age information per tree is derived from a regression model (relationship genus, trunk diameter -> age, 
                        applied to each individual tree) due to the unreliable and incomplete (individual) age data in the original datasets.
                        <br><br>
                        <b>Please note:</b><br>
                        The age (and consequently the age group  as of 2020) refers to the real age (instead of the planting year). 
                        City trees are usually planted at an age between 8 - 12 years.
                    </p>
                </div>

                <!-- ********************** -->
                <!-- genus -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Overview Genus</p>
                    <!-- <p>City trees are usually planted at an age between 8 - 12 years.</p> -->
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Existing trees by genus (>= 1.5% occurance in this cohort)</p>
                            <div id="overview_genus_tree_count" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees by genus (>= 1.5% occurance in this cohort)</p>
                            <div id="overview_genus_cut_tree_count" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Distribution in %</p>
                            <div id="overview_genus_tree_count_perc" class="echart half_page_width"></div>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/genus/tree_count_with_prediction.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Distribution in %</p>
                            <div id="overview_genus_cut_tree_count_perc" class="echart half_page_width"></div>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/genus/cut_tree_count_with_prediction.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                    </ons-row>
                </div>

                <!-- ********************** -->
                <!-- districts |-> tree count
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Overview Districts</p>
                    <p>How many trees are in which district?</p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Absolute numbers of existing (green) and cut down trees (red)</p>
                            <div id="overview_districts_tree_count_num" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Distribution in %</p>
                            <div id="overview_districts_tree_count_perc" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Distribution in % of overall cut down trees</p>
                            <div id="overview_districts_tree_count_perc_overall" class="echart half_page_width"></div>
                            <div style="text-align: left;">
                                <p>
                                    The data shows that 
                                    <ul>
                                        <li>
                                            significantly more trees were felled in Rhodenkirchen and Lindenthal
                                        </li>
                                        <li>
                                            significantly less trees were felled in Porz
                                        </li>
                                    </ul>
                                    compared to other districts.
                                </p>
                            </div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees % of each individual district tree distribution</p>
                            <div id="overview_districts_cut_tree_count_perc_district" class="echart half_page_width"></div>
                            <p style="text-align: left;">
                                If the proportion of trees that no longer exist is examined separately for each district, 
                                Rhodenkirchen also takes the top position in loss compared to the previous tree population.
                            </p>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/districts/tree_count.json" target="_blank">[JSON data]</a>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/districts/cut_tree_count.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                    </ons-row>
                </div> 

                <!-- ********************** -->
                <!-- districts |-> age groups
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Age groups by district</p>
                    <p>
                        How are age groups distributed throughout the districts?
                        <div class="bulletpoints">
                            <div style="float: left; margin-right: 20px;"><span style="background-color: #c3eb34"></span>&lt;= 25 years</div>
                            <div style="float: left; margin-right: 20px;"><span style="background-color: #7aeb34"></span>26 - 40 years</div>
                            <div style="float: left; margin-right: 20px;"><span style="background-color: #2ed93c"></span>&gt; 40 years</div>
                            <div style="float: left; margin-right: 20px;"><span style="background-color: #4f96c9"></span>unknown</div>
                        </div>
                    </p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Absolute numbers of trees by age group</p>
                            <div id="overview_districts_age_groups_num" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Share of age groups in each district</p>
                            <div id="overview_districts_age_groups_perc" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/districts/age_groups_with_predictions.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                    </ons-row>

                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Absolute numbers of cut down trees by age group</p>
                            <div id="overview_districts_cut_trees_age_groups_num" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Share of age groups (cut down trees) in each district</p>
                            <div id="overview_districts_cut_trees_age_groups_perc" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/districts/cut_tree_age_groups_with_predictions.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                    </ons-row>
                </div>

                <!-- ********************** -->
                <!-- districts |-> trees per square km
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Tree density</p>
                    <p>
                        The areas of the districts vary quite considerably, hence the density (trees per square km)
                        can be of interest in certain situations.
                    </p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Existing trees per square km</p>
                            <div id="overview_districts_trees_area_num" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees per square km</p>
                            <div id="overview_districts_cut_trees_area_num" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                </div> 

                <!-- ********************** -->
                <!-- district lists |-> individual district charts -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Districts details</p>
                    <p>Get detailled insights about individual districts and their suburbs.</p>
                    <br>
                    <ons-list>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Innenstadt')" tappable>Innenstadt</ons-list-item>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Rodenkirchen')" tappable>Rodenkirchen</ons-list-item>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Lindenthal')" tappable>Lindenthal</ons-list-item>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Ehrenfeld')" tappable>Ehrenfeld</ons-list-item>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Nippes')" tappable>Nippes</ons-list-item>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Chorweiler')" tappable>Chorweiler</ons-list-item>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Porz')" tappable>Porz</ons-list-item>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Kalk')" tappable>Kalk</ons-list-item>
                        <ons-list-item modifier="chevron" onclick="start_district_details_page('Mülheim')" tappable>Mülheim</ons-list-item>
                    </ons-list>
                </div>
            </div>

        </ons-page>
    </template>


    <!-- ************************************* -->
    <!-- district / suburb page -->
    <!-- ************************************* -->
    <template id="district_page.html">
        <ons-page id="district_page">
            <ons-toolbar id="agent_view_manager_toolbar">
                <div class="left"><ons-back-button>Back to overview</ons-back-button></div>
                <div class="center">Details <span class="suburb_name_text_var"></span></div>
              </ons-toolbar>

            <div class="content_container">
                <!-- ********************** -->
                <!-- suburbs |-> tree / tree cut count
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Suburb tree distribution</p>
                    <p>How many trees are in which suburb?</p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Absolute numbers of existing (green) and cut down trees (red)</p>
                            <div id="overview_suburbs_tree_count_num" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>% share of overall trees in <span class="suburb_name_text_var"></span></p>
                            <div id="overview_suburbs_tree_count_perc" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>% share of overall cut down trees in <span class="suburb_name_text_var"></span></p>
                            <div id="overview_suburbs_tree_count_perc_overall" class="echart half_page_width"></div>
                            <div style="text-align: left;">
                                <p>
                                    
                                </p>
                            </div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees % of each individual suburb tree distribution</p>
                            <div id="overview_suburbs_cut_tree_count_perc_district" class="echart half_page_width"></div>
                            <p style="text-align: left;">
                                
                            </p>
                        </ons-col>
                    </ons-row>
                </div>
            
                <!-- ********************** -->
                <!-- districts |-> age groups
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Age groups by suburbs</p>
                    <p>
                        How are age groups distributed throughout the suburbs?
                        <div class="bulletpoints">
                            <div style="float: left; margin-right: 20px;"><span style="background-color: #c3eb34"></span>&lt;= 25 years</div>
                            <div style="float: left; margin-right: 20px;"><span style="background-color: #7aeb34"></span>26 - 40 years</div>
                            <div style="float: left; margin-right: 20px;"><span style="background-color: #2ed93c"></span>&gt; 40 years</div>
                            <div style="float: left; margin-right: 20px;"><span style="background-color: #4f96c9"></span>unknown</div>
                        </div>
                    </p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Absolute numbers of trees by age group</p>
                            <div id="overview_suburbs_age_groups_num" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Share of age groups in each district</p>
                            <div id="overview_suburbs_age_groups_perc" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/suburbs/age_groups_with_predictions.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                    </ons-row>

                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Absolute numbers of cut down trees by age group</p>
                            <div id="overview_suburbs_cut_trees_age_groups_num" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Share of age groups (cut down trees) in each suburb</p>
                            <div id="overview_suburbs_cut_trees_age_groups_perc" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                    <ons-row>
                        <ons-col>
                            <p>
                                <a href="https://zushicat.github.io/cologne-trees-static-API/endpoints/suburbs/cut_tree_age_groups_with_predictions.json" target="_blank">[JSON data]</a>
                            </p>
                        </ons-col>
                    </ons-row>
                </div>
            </div>
        </ons-page>
    </template>

    <!-- ************************************* -->
    <!-- script section -->
    <!-- ************************************* -->
    <script>
        // prevent caching of once loaded json file
        $(document).ready(function() 
        {
            $.ajaxSetup({ cache: false });
        });

        // ****
        // globals
        // ****
        WINDOW_WIDTH = $(window).width(); // init width
        
        // ************
        // map globals
        // ************
        var MAP;

        var TREE_DATA_BY_ID = {};
        var TREE_MAP_FEATURES = {};  // object (by district if) of lists of trees
        // var CUT_TREE_MAP_FEATURES = {};  // object (by district id) of lists of cut trees

        var DISTRICT_MAP_FEATURES = [];
        var SUBURB_LIST = []

        var DISPLAY_DISTRICT_BORDERS = false;
        var DISPLAY_TREES_DISTRICTS = [];
        var DISPLAY_AGE_GROUPS = [];
        var DISPLAY_LOCATION_TYPES = [];

        var DISTRICT_NAMES_BY_ID = {
            "1": "Innenstadt",
            "2": "Rodenkirchen",
            "3": "Lindenthal",
            "4": "Ehrenfeld",
            "5": "Nippes",
            "6": "Chorweiler",
            "7": "Porz",
            "8": "Kalk",
            "9": "Mülheim"
        }

        // area in square km
        var DISTRICT_AREA_BY_ID = {
            "1": 16.37,
            "2": 54.55,
            "3": 41.80,
            "4": 23.98,
            "5": 31.75,
            "6": 67.16,
            "7": 78.92,
            "8": 38.16,
            "9": 52.20
        }

        var DISTRICT_AREA_BY_NAME = {
            "Innenstadt": 16.37,
            "Rodenkirchen": 54.55,
            "Lindenthal": 41.80,
            "Ehrenfeld": 23.98,
            "Nippes": 31.75,
            "Chorweiler": 67.16,
            "Porz": 78.92,
            "Kalk": 38.16,
            "Mülheim": 52.20
        }

        // ************
        // charts globals
        // ************
        //var API_BASE_URL = "http://localhost/cologne-trees-static-API/endpoints/"  // local debug
        var API_BASE_URL = "https://zushicat.github.io/cologne-trees-static-API/endpoints/"

        var CHARTS_COLORSET_AGE_GROUPS = ["#c3eb34", "#7aeb34", "#2ed93c", "#4f96c9"]
        var CHARTS_COLORSET_DEFAULT = ["#ccc", "#bbb", "#aaa", "#999", "#888", "#777", "#666", "#555", "#444", "#333", "#222", "#111", "#000"]
        var CHARTS_COLORSET_BLACK = ["#222"]

        var CHARTS_LIST = [];

        // *************************************************************
        // side menu
        // *************************************************************
        window.fn = {};

        window.fn.open = function() 
        {
            var menu = document.getElementById('side_menu');
            menu.open();
        };

        window.fn.load = function(page) 
        {
            var content = document.getElementById('map_page');
            var menu = document.getElementById('side_menu');
            
            content.load(page).then(menu.close.bind(menu));
        };

        // *************************************************************
        // event listener (on start)
        // *************************************************************
        document.addEventListener('init', function(event) 
        {
            if(event.target.matches("#map_page")) //('#map_page')) 
            {
                //console.log("map page")
                set_widgets_size();  // init echart widgets width
            }

            if(event.target.matches("#menu")) //('#map_page')) 
            {
                //console.log("menu page")
            }

            if(event.target.matches('#home_splitter'))   //("#home_splitter")) //('#map_page')) 
            {
                // show modal at start
                document.querySelector('ons-modal').show();
                
                //console.log("splitter")
                $.ajaxSetup({ cache: false });  // prevent caching of once loaded json file
                
                load_tree_data(function()
                {
                    console.log("---- data loaded ----");
                    build_district_selection_grid(function()
                    {
                        add_navigation_elements_event_handler();
                        display_map_data();
                    });
                });

                create_main_page_overview_charts();

                load_district_page_globals();
            }

            if(event.target.matches('#district_page')) 
            {
                $.ajaxSetup({ cache: false });
                set_widgets_size();  // init echart widgets width

                var current_district = event.target.data.district_name
                // var current_district = "Innenstadt";
                create_district_details_charts(current_district);
                
            }
        });

        // *************************************************************
        // set echarts widget size and resize event
        // *************************************************************
        function set_widgets_size()
        {
            $(".half_page_width").css("width", parseInt( (WINDOW_WIDTH/2) * 0.9 ));
            $(".full_page_width").css("width", parseInt( WINDOW_WIDTH * 0.9 ));

            $(".half_page_width").css("height", parseInt( ((WINDOW_WIDTH/2) * 0.9) * 0.7 ));
            $(".full_page_width").css("height", ( (WINDOW_WIDTH * 0.9) * 0.7 ));


            for(var i in CHARTS_LIST)
            {
                CHARTS_LIST[i].resize();
            }
        }

        window.onresize = function(event) 
        {
            if(typeof($(window).width()) != "undefined")
                WINDOW_WIDTH = $(window).width();
            set_widgets_size();
        };
        
        // **************************************************************
        //
        // Map
        //
        // **************************************************************
        
        // *************************************************************
        // event listener: navigation elements
        // *************************************************************
        function add_navigation_elements_event_handler()
        {
            // **********
            // menu close on ok
            // **********
            var menu = document.getElementById('side_menu');
            $("#menu_ok_button").on("click", function()
            {
                menu.close()
            });
                

            // **********
            // expandabale list for districts is default expanded
            // **********
            //document.querySelector("#nav_district_button_list_container").showExpansion()

            // **********
            // toggle district border display
            // **********
            var checkbox_selector_district_borders = document.querySelector("#nav_show_district_borders");
            DISPLAY_DISTRICT_BORDERS = checkbox_selector_district_borders.checked;
            
            // add event
            checkbox_selector_district_borders.addEventListener('click', function()
            {
                DISPLAY_DISTRICT_BORDERS = this.checked;
                toogle_display_district_polygons();
            });
            
            // **********
            // toggle district display
            // **********
            var checkbox_selector_district_tree_display = document.querySelectorAll('.nav_district_trees_checkbox')
            for (var i = 0; i < checkbox_selector_district_tree_display.length; i++) 
            {
                // init display of trees in districts
                if(checkbox_selector_district_tree_display[i].getAttribute("checked") != null) 
                    DISPLAY_TREES_DISTRICTS.push(checkbox_selector_district_tree_display[i].getAttribute("data-district"));

                // add event
                checkbox_selector_district_tree_display[i].addEventListener('click', function()
                {
                    if(this.checked == true)
                    {
                        
                        DISPLAY_TREES_DISTRICTS.push(this.getAttribute("data-district"))
                    }
                    else  // remove de-selected from global list
                    {
                        for(var j = 0; j < DISPLAY_TREES_DISTRICTS.length; j++)
                            if(DISPLAY_TREES_DISTRICTS[j] === this.getAttribute("data-district"))
                                DISPLAY_TREES_DISTRICTS.splice(j, 1); 
                    }
                    
                    toogle_display_trees_district();
                    change_text_map_info();
                });
            }

            // **********
            // switch map style
            // **********
            var selectors_style = document.querySelectorAll('input[name="nav_switch_map_style"]')
            for (var i = 0; i < selectors_style.length; i++) 
            {
                selectors_style[i].addEventListener('click', function()
                {
                    if(this.value == "satellite")
                        MAP.setStyle("mapbox://styles/mapbox/satellite-v9");
                    else
                        MAP.setStyle("mapbox://styles/zushicat/ckbcadygg11ao1irxsfxy1jzx");
                });
            };

            // **********
            // filter age group display
            // **********
            var checkbox_selector_age_group_display = document.querySelectorAll('.nav_age_group_checkbox')
            for (var i = 0; i < checkbox_selector_age_group_display.length; i++) 
            {
                // init
                if(checkbox_selector_age_group_display[i].getAttribute("checked") != null) 
                    DISPLAY_AGE_GROUPS.push(checkbox_selector_age_group_display[i].getAttribute("data-agegroup"));
                
                checkbox_selector_age_group_display[i].addEventListener('click', function()
                {
                    if(this.checked == true)
                    {
                        DISPLAY_AGE_GROUPS.push(this.getAttribute("data-agegroup"))
                    }
                    else  // remove de-selected from global list
                    {
                        for(var j = 0; j < DISPLAY_AGE_GROUPS.length; j++)
                            if(DISPLAY_AGE_GROUPS[j] === this.getAttribute("data-agegroup"))
                                DISPLAY_AGE_GROUPS.splice(j, 1); 
                    }
                    set_filter_display_selection();
                });
            }

            // **********
            // filter location type display
            // **********
            var checkbox_selector_age_group_display = document.querySelectorAll('.nav_location_type_checkbox')
            for (var i = 0; i < checkbox_selector_age_group_display.length; i++) 
            {
                // init
                if(checkbox_selector_age_group_display[i].getAttribute("checked") != null) 
                DISPLAY_LOCATION_TYPES.push(checkbox_selector_age_group_display[i].getAttribute("data-locationtype"));
                
                checkbox_selector_age_group_display[i].addEventListener('click', function()
                {
                    if(this.checked == true)
                    {
                        DISPLAY_LOCATION_TYPES.push(this.getAttribute("data-locationtype"))
                    }
                    else  // remove de-selected from global list
                    {
                        for(var j = 0; j < DISPLAY_LOCATION_TYPES.length; j++)
                            if(DISPLAY_LOCATION_TYPES[j] === this.getAttribute("data-locationtype"))
                                DISPLAY_LOCATION_TYPES.splice(j, 1); 
                    }
                    set_filter_display_selection();
                    change_text_map_info();
                });
            }
        }

        // **************************************************************
        // navigation elements
        // **************************************************************
        function build_district_selection_grid(callback)
        {
            j=-1
            for(var i in SUBURB_LIST)
            {
                if(i%3 == 0)
                {
                    j++;
                    var tmp_list = $('<ons-col><ons-list modifier="noborder"></ons-list></ons-col>');
                    $("ons-list", tmp_list).attr("id", "nav_district_trees_grid_" + j);
                    $("#nav_selected_districts_container").append(tmp_list);
                }
                
                var tmp_checked = "";
                if(["1"].includes(SUBURB_LIST[i]))  // Innenstadt
                    tmp_checked = "checked";

                var tmp_element = 
                $('<ons-list-item tappable  modifier="nodivider">\
                    <label class="left">\
                        <ons-checkbox data-district="' + SUBURB_LIST[i] + '" class="nav_district_trees_checkbox" input-id="nav_district_trees_element_' + i + '" ' + tmp_checked + '></ons-checkbox>\
                    </label>\
                    <label for="nav_district_trees_element_' + i + '" class="center">' + DISTRICT_NAMES_BY_ID[SUBURB_LIST[i]] + '</label>\
                </ons-list-item>');

                $("#nav_district_trees_grid_" + j).append(tmp_element)
            }
            callback()
        }

        // **************************************************************
        //
        // **************************************************************
        function load_tree_data(callback)
        {
            var count = 0;

            // loading a zip file with a progress callback
            JSZipUtils.getBinaryContent("src/data/app_data.zip", 
            {
                progress: function (e) {
                    // console.log(e.percent + "% of " + e.path+ " loaded")
                },
                callback: function (err, data) 
                {
                    if(err) {
                        throw err; // or handle the error
                    }
                    var zip = new JSZip();
                    zip.loadAsync(data).then(function(contents) 
                    {
                        Object.keys(contents.files).forEach(function(filename) 
                        {
                            zip.file(filename).async('string').then(function(content) 
                            {
                                if(filename == "trees_cologne_reduced.jsonln")
                                {
                                    tree_data_lines = content.split("\n");
                                    // console.log("all: ", tree_data_lines.length);
                                    for(var i in tree_data_lines)
                                    {
                                        try 
                                        {
                                            // if(i%10000 == 0)
                                            //     console.log(i);
                                            var tree_data = JSON.parse(tree_data_lines[i]);
                                        
                                            var tree_id = tree_data.tree_id;
                                            var lat = tree_data.lat;
                                            var lng = tree_data.lng;

                                            var genus = tree_data.genus;
                                            var in_dataset_2020 = tree_data.in_dataset_2020;
                                            var location_type = tree_data.location_type;
                                            
                                            var district_number = tree_data.district_number;
                                            if(district_number == null)
                                                continue;
                                            district_number = district_number.toString();
                                            
                                            // *****
                                            // age
                                            var age_group = null;
                                            if(tree_data.age_group != null)
                                                age_group = tree_data.age_group;
                                            else
                                                age_group = 3;  // unknown

                                            // ****
                                            // mark cut down trees in age group
                                            // for display switch: set age: -1 if cut down
                                            if(in_dataset_2020 == false)
                                                age_group = -1;
                                            
                                            if(TREE_MAP_FEATURES[district_number] == null)
                                                TREE_MAP_FEATURES[district_number] = []
                                            
                                            var tree_feature = 
                                            {
                                                "type": "Feature",
                                                "geometry": 
                                                {
                                                    "type": "Point",
                                                    "coordinates": [lng, lat]
                                                },
                                                "properties": 
                                                {
                                                    "id": tree_id,
                                                    "age_group": age_group,
                                                    "genus": genus,
                                                    "in_dataset_2020": in_dataset_2020,
                                                    "location_type": location_type,
                                                }
                                            }

                                            TREE_DATA_BY_ID[tree_id] = tree_data;
                                            TREE_MAP_FEATURES[district_number].push(tree_feature);
                                            
                                            // if(in_dataset_2020 == true)
                                            // {
                                            //     TREE_DATA_BY_ID[tree_id] = tree_data;
                                            //     TREE_MAP_FEATURES[district_number].push(tree_feature);
                                            // }
                                            // else
                                            // {
                                            //     TREE_DATA_BY_ID[tree_id] = tree_data;
                                            //     CUT_TREE_MAP_FEATURES[district_number].push(tree_feature);
                                            // }
                                        }
                                        catch { console.log("!!!!") }
                                    }
                                    count++;
                                    if(count==2)
                                        callback()
                                }
                                if(filename == "cologne_districts_polygons.json")
                                {
                                    var suburb_data = JSON.parse(content).features;
                                    
                                    for(var i in suburb_data)
                                    {
                                        var suburb_id = suburb_data[i].properties.NUMMER;
                                        var suburb_name = suburb_data[i].properties.NAME;

                                        var district_id = suburb_data[i].properties.NR_STADTBEZIRK;
                                        var district_name = suburb_data[i].properties.STADTBEZIRK;

                                        var coordinates = suburb_data[i].geometry.coordinates;
                                        
                                        
                                        tmp = {
                                            "type": "Feature",
                                            "geometry": 
                                            {
                                                "type": "Polygon",
                                                "coordinates": coordinates
                                            },
                                            "properties": {
                                                "id": district_id,
                                                "title": district_name
                                            }
                                        }
                                        DISTRICT_MAP_FEATURES.push(tmp)
                                        
                                        if(SUBURB_LIST.includes(district_id) == false)
                                            SUBURB_LIST.push(district_id);
                                    }
                                    count++;
                                    if(count==2)
                                        callback()
                                }
                            })
                        })
                    })
                }
            });
        }

        // **************************************************************
        //
        // **************************************************************
        function init_map()
        {
            var baseLayers = 
            [
                { label: 'streets', style: "mapbox://styles/mapbox/satellite-v9" }, 
                { label: 'satellite', style: "mapbox://styles/zushicat/ckbcadygg11ao1irxsfxy1jzx" }
            ];

            mapboxgl.accessToken = 'pk.eyJ1IjoienVzaGljYXQiLCJhIjoiY2p1Y2o0bGR6MGNnZjRka2IzcmNraGtyZSJ9.wBS9jxpUT9vWhsCiWF_z5w';
            
            // *********
            // init map
            MAP = new mapboxgl.Map(
            {
                container: 'tree_map',
                style: 'mapbox://styles/zushicat/ckbcadygg11ao1irxsfxy1jzx', // stylesheet location
                center: [6.953101, 50.935173], // starting position [lng, lat]
                zoom: 13 // starting zoom
            });

            // *********
            // add geoccoder search
            MAP.addControl(new MapboxGeocoder(
            {
                accessToken: mapboxgl.accessToken,
                countries: 'de',  // limit results to Australia
                bbox: [6.731135, 50.860533, 7.225520, 51.032067],  // further limit results to geographic bounds
                
                // apply a client side filter to further limit results to those strictly within
                // the New South Wales region
                filter: function(item) 
                {
                    // console.log(item)
                    // returns true if item contains New South Wales region
                    return item.context.map(function(i) {
                        // id is in the form {index}.{id} per https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                        // this example attempts to find the `region` named `New South Wales`
                        return (
                            i.id.split('.').shift() === 'region' &&
                            i.text === 'Nordrhein-Westfalen'
                        );
                    }).reduce(function(acc, cur) 
                    {
                        return acc || cur;
                    });
                },
                mapboxgl: mapboxgl
            }));

            // ***
            // toggle full screen
            MAP.addControl(new mapboxgl.FullscreenControl());

            // ***
            // disable map zoom when using scroll
            MAP.scrollZoom.disable();

            // ***
            // Add zoom and rotation controls to the map
            // disable map rotation using navigation
            MAP.addControl(new mapboxgl.NavigationControl({
                showCompass: false,
                showZoom: true
            }));

            // ***
            // disable map rotation 
            MAP.dragRotate.disable(); // using right click + drag
            MAP.touchZoomRotate.disableRotation(); // using touch rotation gesture
        }

        // **************************************************************
        //
        // **************************************************************
        function create_tree_layer()
        {
            for(var district_number in TREE_MAP_FEATURES)
            {
                if(district_number == null)
                    continue
                
                MAP.addSource('trees_' + district_number, 
                {
                    'type': 'geojson',
                    'data': 
                    {
                        'type': 'FeatureCollection',
                        'features': TREE_MAP_FEATURES[district_number]
                    }
                });

                // init visibility
                var layer_visibility = "none";
                if(DISPLAY_TREES_DISTRICTS.includes(district_number) == true)
                    layer_visibility = "visible";

                MAP.addLayer(
                {
                    "id": 'all_trees_layer_' + district_number,
                    "type": 'circle',
                    "source": 'trees_' + district_number,
                    "paint": 
                    {
                        "circle-radius": {
                            "base": 1.75,
                            "stops": [
                                [12, 1],
                                [22, 100]
                            ]
                        },
                        "circle-opacity": [
                            'interpolate',
                            ['exponential', 0.5],
                            ['zoom'],
                            12,
                            1.0,
                            22,
                            0.5
                        ],
                        //'circle-color': "#3db023",
                        // color circles by age_group of trees, using a match expression
                        // https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match
                        'circle-color': [
                        'match',
                            ['get', 'age_group'],
                            0,
                            "#c3eb34",
                            1,
                            "#7aeb34",
                            2,
                            "#2ed93c",
                            3,
                            "#4f96c9", 
                            /* other / cut down == -1 */ "#ff0000"
                        ]
                    },
                    'layout': 
                    {
                        'visibility': layer_visibility
                    }
                });
            }
        }

        function create_district_polygon_layer()
        {
            // MAP.on('load', function() 
            // {
                MAP.addSource('districts', 
                {
                    'type': 'geojson',
                    'data': 
                    {
                        'type': 'FeatureCollection',
                        'features': DISTRICT_MAP_FEATURES
                    }
                });

                // init visibility
                var layer_visibility = "none";
                if(DISPLAY_DISTRICT_BORDERS == true)
                    layer_visibility = "visible";

                MAP.addLayer(
                {
                    'id': 'districts_layer',
                    'type': 'line',
                    'source': 'districts',
                    'layout': 
                    {
                        // make layer visible by default
                        'visibility': layer_visibility,
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                    'line-color': '#fc8403',
                    'line-width': 1
                    }
                });
            // });
        }
        
        
        // **************************************************************
        // toggle map display from selection
        // **************************************************************
        function toogle_display_district_polygons()
        {
            var map_layer_id = "districts_layer";
            
            if(DISPLAY_DISTRICT_BORDERS == false)
            {
                MAP.setLayoutProperty(map_layer_id, "visibility", "none");
            }
            else 
            {
                MAP.setLayoutProperty(map_layer_id, "visibility", "visible");
            }
        }

        function toogle_display_trees_district()
        {
            var map_layer = MAP.getStyle().layers;

            for(var i in map_layer)
            {
                if(map_layer[i].id.indexOf("all_trees_layer_") == -1) // && map_layer[i].id.indexOf("cut_trees_layer_") == -1)
                    continue
                
                if(map_layer[i].id.indexOf("all_trees_layer_") != -1)
                {
                    var current_district_num = map_layer[i].id.replace("all_trees_layer_", "");
                    if(DISPLAY_TREES_DISTRICTS.includes(current_district_num))
                    {
                        MAP.setLayoutProperty(map_layer[i].id, "visibility", "visible");
                    }
                    else
                    {
                        MAP.setLayoutProperty(map_layer[i].id, "visibility", "none");
                    }
                }

                // if(map_layer[i].id.indexOf("cut_trees_layer_") != -1)
                // {
                //     var current_district_num = map_layer[i].id.replace("cut_trees_layer_", "");
                //     if(DISPLAY_TREES_DISTRICTS.includes(current_district_num))
                //         MAP.setLayoutProperty(map_layer[i].id, "visibility", "visible");
                //     else
                //         MAP.setLayoutProperty(map_layer[i].id, "visibility", "none");
                // }
            }

            // for(var i in DISPLAY_TREES_DISTRICTS)
            // {
            //     var map_layer_id = "all_trees_layer_" + DISPLAY_TREES_DISTRICTS[i];
            //     MAP.setLayoutProperty(map_layer_id, "visibility", "visible");
            // }
        }

        function change_text_map_info()
        {
            $("#map_info_displayed_districts").empty();
            $("#map_info_displayed_location_type").empty();

            if(DISPLAY_TREES_DISTRICTS.length == 0)
            {
                $("#map_info_displayed_districts").append("<li>no district selected</li>");
            }
            else
            {
                for(var i in DISPLAY_TREES_DISTRICTS)
                {
                    var district_id = DISPLAY_TREES_DISTRICTS[i];
                    var district_name = DISTRICT_NAMES_BY_ID[district_id];

                    $("#map_info_displayed_districts").append("<li>" + district_name + "</li>");
                }
            }

            if(DISPLAY_LOCATION_TYPES.length == 0)
            {
                $("#map_info_displayed_location_type").append("<li>no location type selected</li>");
            }
            else
            {
                for(var i in DISPLAY_LOCATION_TYPES)
                {
                    var location_type_name = DISPLAY_LOCATION_TYPES[i].replace(/_/g, " ");
                    $("#map_info_displayed_location_type").append("<li>" + location_type_name + "</li>");
                }
            }
            
        }

        // **************************************************************
        // filter selection
        // **************************************************************
        function set_filter_display_selection()
        {
            var tmp_filtered_age_group = [];
            for(var i in DISPLAY_AGE_GROUPS)
                tmp_filtered_age_group.push(parseInt(DISPLAY_AGE_GROUPS[i]))
            
            var tmp_filtered_location_type = [];
            for(var i in DISPLAY_LOCATION_TYPES)
                tmp_filtered_location_type.push(DISPLAY_LOCATION_TYPES[i])
            
            for(var i in SUBURB_LIST)
            {
                var tmp_layer = "all_trees_layer_" + SUBURB_LIST[i]
                MAP.setFilter(
                    tmp_layer, 
                    [
                        "all",
                        [
                            'match', 
                            ['get', 'location_type'], 
                            tmp_filtered_location_type, 
                            true, 
                            false
                        ],
                        [
                            'match', 
                            ['get', 'age_group'], 
                            tmp_filtered_age_group, 
                            true, 
                            false
                        ]
                    ]
                );
            }
        }


        // **************************************************************
        //
        // **************************************************************
        function display_map_data()
        {
            console.log("---- do map stuff ----");
            
            init_map();

            MAP.on('style.load', function() 
            {
                create_district_polygon_layer();
                create_tree_layer();
                
                // console.log("render trees on map");
                set_filter_display_selection();

                MAP.on('sourcedata', function(e) 
                {
                    show_modal = e.isSourceLoaded;
                    if (e.isSourceLoaded) 
                    {
                        // console.log("done rendering");
                        document.querySelector('ons-modal').hide({animation: "fade"});
                    }
                    else
                    {
                        // console.log("----> SHOW MODAL");
                        // document.querySelector('ons-modal').show();
                    }
                });

                
                var map_layer = MAP.getStyle().layers;
                
                var map_layer_ids = [];
                for (var i = 0; i < map_layer.length; i++) 
                {
                    if(map_layer[i].id.search("trees_layer") == -1)
                        continue;
                    map_layer_ids.push(map_layer[i].id);
                }

                
                MAP.on('click', function(e) 
                {
                    var features = MAP.queryRenderedFeatures(e.point, {
                        layers: map_layer_ids // replace this with the name of the layer
                    });

                    if (!features.length) {
                        return;
                    }

                    var feature = features[0];
                    
                    var coordinates = feature.geometry.coordinates.slice();
                    var tree_id = feature.properties.id;
                    var age_group = feature.properties.age_group;
                    var genus = feature.properties.genus;
                    var in_dataset_2020 = feature.properties.in_dataset_2020;
                    var location_type = feature.properties.location_type;

                    var description_html = "<p>\
                        Tree_ID:<br>" + tree_id + "<br>\
                        Age group: " + age_group + "<br>\
                        Genus: " + genus + "<br>\
                        Location type: " + location_type + "<br>\
                        Still existing: " + in_dataset_2020 + "</p>\
                    "

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(description_html)
                        .addTo(MAP);
                });            
            });
        }

    

        // **************************************************************
        //
        // Charts |-> map page
        //
        // **************************************************************
        function get_json_data(endpoint, callback)
        {
            $.ajax(
            {
                url: API_BASE_URL + endpoint,
                success: function(data)
                {
                    callback(data);
                }
            });
        }

        function create_main_page_overview_charts()
        {
            // ***
            // data completeness
            get_json_data("meta/data_completeness.json", function(json_data)
            {
                // console.log(json_data);
                var data = [];
                for(key in json_data)
                {
                    var value = json_data[key]["mean"];
                    data.push({"value": value, "name": key.replace(/_/g, " ")});
                }
                
                draw_simple_bar_chart(data, "overview_data_completeness", CHARTS_COLORSET_BLACK)
            });

            // ***
            // overall count
            get_json_data("meta/overall_tree_count.json", function(json_data)
            {
                // console.log(json_data);
                var data = [];
                for(key in json_data)
                {
                    if(key == "percentage_cut_down_since_2017")
                    {
                        $("#overview_percentage_cut_down").text(parseInt(json_data[key] * 100))
                        continue;
                    }
                    if(key == "cut_down_trees")
                    {
                        $("#overview_number_cut_down").text(parseInt(json_data[key]))
                    }

                    var value = json_data[key];
                    data.push({"value": value, "name": key.replace(/_/g, " ")});
                }
                draw_simple_bar_chart(data, "overview_tree_count", CHARTS_COLORSET_BLACK)
            });

            // *********
            // object type
            // *********
            // tree count |---> bar / pie chart 
            get_json_data("object_type/tree_count.json", function(json_data)
            {
                var data_abs = [];
                var data_perc = [];
                for(key in json_data)
                {
                    var value_abs = json_data[key]["absolute"];
                    var value_perc = json_data[key]["percentage"] * 100;
                    data_abs.push({"value": value_abs, "name": key.replace(/_/g, " ")});
                    data_perc.push({"value": value_perc, "name": key.replace(/_/g, " ")});
                }
                
                draw_simple_bar_chart(data_abs, "overview_object_type_tree_count", CHARTS_COLORSET_BLACK)
                draw_pie_chart(data_perc, "overview_object_type_tree_count_perc", CHARTS_COLORSET_DEFAULT, true)
            });

            // ***
            // cut tree count
            // count trees
            get_json_data("object_type/cut_tree_count.json", function(json_data)
            {
                var data_abs = [];
                var data_perc = [];
                for(key in json_data)
                {
                    var value_abs = json_data[key]["absolute"];
                    var value_perc = json_data[key]["percentage"] * 100;
                    data_abs.push({"value": value_abs, "name": key.replace(/_/g, " ")});
                    data_perc.push({"value": value_perc, "name": key.replace(/_/g, " ")});
                }
                
                draw_simple_bar_chart(data_abs, "overview_object_type_cut_tree_count", CHARTS_COLORSET_BLACK)
                draw_pie_chart(data_perc, "overview_object_type_cut_tree_count_perc", CHARTS_COLORSET_DEFAULT, true)
            });

            // *********
            // location type
            // *********
            // (cut / existing) tree count: location type |---> bar
            get_json_data("location_type/tree_count_location_type.json", function(json_data)
            {
                get_json_data("location_type/cut_tree_count_location_type.json", function(json_data_cut)
                {
                    var data = [];
                    var data_cut = []
                    for(key in json_data)  // corresponding keys
                    {
                        var value = json_data[key];
                        var value_cut = json_data_cut[key];
                        data.push({"value": value, "name": key.replace(/_/g, " ")});
                        data_cut.push({"value": value_cut, "name": key.replace(/_/g, " ")});
                    }
                    
                    draw_simple_bar_chart(data, "overview_location_type_tree_count", CHARTS_COLORSET_BLACK)
                    draw_simple_bar_chart(data_cut, "overview_location_type_cut_tree_count", CHARTS_COLORSET_BLACK)
                });
            });

            // (cut / existing) tree count: (location) osm key |---> bar
            get_json_data("location_type/tree_count_osm_keys.json", function(json_data)
            {
                get_json_data("location_type/cut_tree_count_osm_keys.json", function(json_data_cut)
                {
                    var data = [];
                    var data_cut = []
                    for(key in json_data)  // corresponding keys
                    {
                        var value = json_data[key];
                        var value_cut = json_data_cut[key];

                        if(key == "highway" || key == "unknown")
                            continue;

                        data.push({"value": value, "name": key.replace(/_/g, " ")});
                        data_cut.push({"value": value_cut, "name": key.replace(/_/g, " ")});
                    }
                    
                    draw_simple_bar_chart(data, "overview_location_type_tree_count_osm_key", CHARTS_COLORSET_BLACK)
                    draw_simple_bar_chart(data_cut, "overview_location_type_cut_tree_count_osm_key", CHARTS_COLORSET_BLACK)
                });
            });

            // *********
            // age groups
            // *********
            // age groups |-> count (existing) trees
            get_json_data("agegroups/tree_count_with_predictions.json", function(json_data)
            {
                var data = [];
                for(key in json_data)
                {
                    var value = json_data[key]["absolute"];
                    substitute_key = {
                        "unknown": "unknown", 
                        "0": "<= 25", 
                        "1": "26 - 40", 
                        "2": "> 40"
                    }
                    
                    key = substitute_key[key.toString()]
                    
                    data.push({"value": value, "name": key});
                }
                draw_pie_chart(data, "overview_agegroups_tree_count", CHARTS_COLORSET_AGE_GROUPS)
            })

            // ***
            // age groups |-> count cut trees
            get_json_data("agegroups/cut_tree_count_with_predictions.json", function(json_data)
            {
                var data = [];
                for(key in json_data)
                {
                    var value = json_data[key]["absolute"];
                    substitute_key = {
                        "unknown": "unknown", 
                        "0": "<= 25", 
                        "1": "26 - 40", 
                        "2": "> 40"
                    }
                    
                    key = substitute_key[key.toString()]
                    
                    data.push({"value": value, "name": key});
                }
                draw_pie_chart(data, "overview_agegroups_cut_tree_count", CHARTS_COLORSET_AGE_GROUPS)
            })
        
            // *********
            // genus
            // *********
            // genus |-> count (existing) trees
            get_json_data("meta/genus_name_german.json", function(json_data_names)
            {
                // console.log(json_data_names)
                get_json_data("genus/tree_count_with_prediction.json", function(json_data)
                {
                    var data_abs = [];
                    var data_perc = [];
                    for(key in json_data)
                    {
                        var name_german = json_data_names[key];
                        
                        var abs_value = json_data[key]["absolute"];
                        var perc_value = (json_data[key]["percentage"] * 100).toFixed(1);

                        if(perc_value < 1.5)
                            continue;
                        
                        if(typeof(name_german) !== "undefined")
                            key = name_german;
                        
                        data_abs.push({"value": abs_value, "name": key});
                        data_perc.push({"value": perc_value, "name": key});
                    }
                    draw_simple_bar_chart(data_abs, "overview_genus_tree_count", CHARTS_COLORSET_BLACK)
                    draw_pie_chart(data_perc, "overview_genus_tree_count_perc", CHARTS_COLORSET_DEFAULT, true)
                });

                get_json_data("genus/cut_tree_count_with_prediction.json", function(json_data)
                {
                    var data_abs = [];
                    var data_perc = [];
                    for(key in json_data)
                    {
                        var name_german = json_data_names[key];
                        
                        var abs_value = json_data[key]["absolute"];
                        var perc_value = (json_data[key]["percentage"] * 100).toFixed(1);

                        if(perc_value < 1.5)
                            continue;
                        
                        if(typeof(name_german) !== "undefined")
                            key = name_german;
                        
                        data_abs.push({"value": abs_value, "name": key});
                        data_perc.push({"value": perc_value, "name": key});
                    }
                    draw_simple_bar_chart(data_abs, "overview_genus_cut_tree_count", CHARTS_COLORSET_BLACK)
                    draw_pie_chart(data_perc, "overview_genus_cut_tree_count_perc", CHARTS_COLORSET_DEFAULT, true)
                });
            })
        
            
            // *********
            // districts numbers
            // *********
            // districts |-> percentage & abs.
            get_json_data("districts/tree_count.json", function(json_data_exist)
            {
                var tmp_district_values = {};
                var data_piechart = []
                var data_cut_down_perc = [];
                var data_density = [];

                get_json_data("districts/cut_tree_count.json", function(json_data_cut_down)
                {
                    var tmp_values = [];
                    var axis_keys = []
                    var existing_values = []

                    var existing_tree_density = [];
                    var cutdown_tree_density = [];

                    var cutdown_values = []
                    var cutdown_values_district = []
                    var cutdown_values_overall = []

                    for(key in json_data_cut_down)  // same keys in both datasets
                    {
                        if(key == "unknown")
                            continue;

                        existing_tree_density.push({
                            "value": json_data_exist[key]["absolute"]/DISTRICT_AREA_BY_NAME[key],
                            "name": key
                        });
                        cutdown_tree_density.push({
                            "value": json_data_cut_down[key]["absolute"]/DISTRICT_AREA_BY_NAME[key],
                            "name": key
                        });

                        axis_keys.push(key)
                        existing_values.push(json_data_exist[key]["absolute"]);
                        cutdown_values.push(json_data_cut_down[key]["absolute"]);

                        cutdown_values_district.push({
                            "value": ((json_data_cut_down[key]["absolute"]/(json_data_exist[key]["absolute"] + json_data_cut_down[key]["absolute"])) * 100).toFixed(2), 
                            "name": key
                        });
                        cutdown_values_overall.push({"value": (json_data_cut_down[key]["percentage"]*100).toFixed(2), "name": key});


                        // for pechart percentages
                        data_piechart.push({"value": (json_data_exist[key]["percentage"]*100).toFixed(2), "name": key});
                    }

                    var data = [];
                    data.push({"type": 'bar', "stack": 'districts', "data": existing_values});
                    data.push({"type": 'bar', "stack": 'districts', "data": cutdown_values});

                    draw_stacked_bar_chart(data, axis_keys, "overview_districts_tree_count_num", ["#2fd93d", "#d95f2f"])
                    draw_pie_chart(data_piechart, "overview_districts_tree_count_perc", CHARTS_COLORSET_DEFAULT, true)

                    draw_pie_chart(cutdown_values_overall, "overview_districts_tree_count_perc_overall", CHARTS_COLORSET_DEFAULT, true)
                    draw_simple_bar_chart(cutdown_values_district, "overview_districts_cut_tree_count_perc_district", CHARTS_COLORSET_BLACK)
                
                    draw_simple_bar_chart(existing_tree_density, "overview_districts_trees_area_num", CHARTS_COLORSET_BLACK)
                    draw_simple_bar_chart(cutdown_tree_density, "overview_districts_cut_trees_area_num", CHARTS_COLORSET_BLACK)
                    //overview_districts_trees_area_num //DISTRICT_AREA_BY_NAME
                    // overview_districts_cut_trees_area_num
                })
            })

            // districts |-> age group (existing)
            get_json_data("districts/age_groups_with_predictions.json", function(json_data)
            {
                var axis_keys = [];
                var age_group_vals_num = {"0": [], "1": [], "2": [], "unknown": []};
                var age_group_vals_perc = {"0": [], "1": [], "2": [], "unknown": []};
                
                for(key in json_data)  // same keys in both datasets
                {
                    if(key == "unknown")
                        continue;
                    
                    axis_keys.push(key)
                    var age_keys = ["0", "1", "2", "unknown"];
                    age_keys.forEach(function (agekey, i) 
                    {
                        var age_value_num = 0;
                        var age_value_perc = 0;
                        if(typeof(json_data[key][agekey]) !== "undefined")
                        {
                            age_value_num = json_data[key][agekey]["absolute"];
                            age_value_perc = (json_data[key][agekey]["percentage"] * 100).toFixed(0);
                        }
                        age_group_vals_num[agekey].push(age_value_num);
                        age_group_vals_perc[agekey].push(age_value_perc);
                    });
                    // for(var agekey in json_data[key])
                    // {
                    //     age_group_vals_num[agekey].push(json_data[key][agekey]["absolute"]);
                    //     age_group_vals_perc[agekey].push( (json_data[key][agekey]["percentage"] * 100).toFixed(0) );
                    // }
                }
                var data_num = [];
                var data_perc = [];
                for(var i in Object.values(age_group_vals_num))  // i is corresponding
                {
                    data_num.push({"type": 'bar', "stack": 'districts', "data": Object.values(age_group_vals_num)[i]});
                    data_perc.push({"type": 'bar', "stack": 'districts', "data": Object.values(age_group_vals_perc)[i]});
                }
                draw_stacked_bar_chart(data_num, axis_keys, "overview_districts_age_groups_num", CHARTS_COLORSET_AGE_GROUPS);
                draw_stacked_bar_chart(data_perc, axis_keys, "overview_districts_age_groups_perc", CHARTS_COLORSET_AGE_GROUPS);
            });

            // districts |-> age group (cut down trees)
            get_json_data("districts/cut_tree_age_groups_with_predictions.json", function(json_data)
            {
                var axis_keys = [];
                var age_group_vals_num = {"0": [], "1": [], "2": [], "unknown": []};
                var age_group_vals_perc = {"0": [], "1": [], "2": [], "unknown": []};
                
                for(key in json_data)  // same keys in both datasets
                {
                    if(key == "unknown")
                        continue;
                    
                    axis_keys.push(key)
                    var age_keys = ["0", "1", "2", "unknown"];
                    age_keys.forEach(function (agekey, i) 
                    {
                        var age_value_num = 0;
                        var age_value_perc = 0;
                        if(typeof(json_data[key][agekey]) !== "undefined")
                        {
                            age_value_num = json_data[key][agekey]["absolute"];
                            age_value_perc = (json_data[key][agekey]["percentage"] * 100).toFixed(0);
                        }
                        age_group_vals_num[agekey].push(age_value_num);
                        age_group_vals_perc[agekey].push(age_value_perc);
                    });
                    // for(var agekey in json_data[key])
                    // {
                    //     age_group_vals_num[agekey].push(json_data[key][agekey]["absolute"]);
                    //     age_group_vals_perc[agekey].push( (json_data[key][agekey]["percentage"] * 100).toFixed(0) );
                    // }
                }
                var data_num = [];
                var data_perc = [];
                for(var i in Object.values(age_group_vals_num))  // i is corresponding
                {
                    data_num.push({"type": 'bar', "stack": 'districts', "data": Object.values(age_group_vals_num)[i]});
                    data_perc.push({"type": 'bar', "stack": 'districts', "data": Object.values(age_group_vals_perc)[i]});
                }
                draw_stacked_bar_chart(data_num, axis_keys, "overview_districts_cut_trees_age_groups_num", CHARTS_COLORSET_AGE_GROUPS);
                draw_stacked_bar_chart(data_perc, axis_keys, "overview_districts_cut_trees_age_groups_perc", CHARTS_COLORSET_AGE_GROUPS);
            });

            // genus |-> year_sprout / bole_radius comparison: gt / regression
            // get_json_data("genus/regression_bole_radius_year_sprout.json", function(json_data_regression)
            // {
            //     get_json_data("genus/ground_truth_bole_radius_year_planting.json", function(json_data_gt)
            //     {
            //         // get data from regression -> [[25, 1996]]
            //         var genus = "Platanus"
            //         var line_data = []
            //         for(bole_radius in json_data_regression[genus])
            //         {
            //             if(parseInt(bole_radius) > 200)
            //                 continue

            //             for(year in json_data_regression[genus][bole_radius])
            //             {
            //                 line_data.push([parseInt(bole_radius), parseInt(year)])
            //             }
            //         }

            //         // get data from gt -> [[25, 1990, 10]]
            //         var bubble_chart_data = []
            //         for(bole_radius in json_data_gt[genus])
            //         {
            //             for(year in json_data_gt[genus][bole_radius])
            //             {
            //                 year = parseInt(year) - 10;
            //                 if(year < 1800)
            //                     continue;

            //                 var tree_num = json_data_gt[genus][bole_radius][year]
            //                 bubble_chart_data.push([parseInt(bole_radius), year, parseInt(tree_num)])
            //             }
            //         }

            //         bubble_scatter_line(line_data, bubble_chart_data, "overview_age_gt_regression")
            //     });
            // });
        }

        // *****
        // draw widgets
        // *****
        function draw_pie_chart(data, chart_div_id, color_set, sorted_data) 
        {
            function get_series_data(current_data)
            {
                var processed_data = current_data; // unsorted
                if(sorted_data == true)
                {
                    processed_data = processed_data.sort(function (a, b) { return a.value - b.value; });
                }
                return processed_data;
            }


            var current_echart = echarts.init(document.getElementById(chart_div_id));
            
            option = {
                tooltip: {
                    trigger: 'item',
                    formatter: "{b}<br/>{c}"
                },
                grid: { containLabel: true },
                color: color_set,
                series: [
                    {
                        name:'Label sale',
                        type:'pie',
                        radius: ['40%', '70%'],
                        label: {normal: {textStyle: { color: '#333' }}},
                        labelLine: {normal: {lineStyle: { color: '#333'}}},
                        data: get_series_data(data),  //data, //data.sort(function (a, b) { return a.value - b.value; }) else data,
                    }
                ]
            };
            
            current_echart.setOption(option);
            CHARTS_LIST.push(current_echart);
        }

        function draw_simple_bar_chart(data, chart_div_id, color_set)
        {
            var current_echart = echarts.init(document.getElementById(chart_div_id));
            
            keys = [];
            values = [];
            for (var i in data) 
            {
                keys.push(data[i].name)
                values.push(data[i].value)
            }

            option = {
                xAxis: {
                    type: 'category',
                    data: keys,
                    axisLabel: {
                        rotate: 50
                    },
                },
                yAxis: {
                    type: 'value'
                },
                grid: { containLabel: true },
                color: color_set,
                series: [{
                    data: values,
                    type: 'bar'
                }]
            }; 

            current_echart.setOption(option);
            CHARTS_LIST.push(current_echart)
        }

        function draw_stacked_bar_chart(data, axis_keys, chart_div_id, color_set)
        {
            var current_echart = echarts.init(document.getElementById(chart_div_id));

            option = {
                tooltip: {
                    trigger: 'item',
                    //formatter: "{b}<br/>absolute number: {c}"
                },
                xAxis: {
                    type: 'category',
                    data: axis_keys,
                    axisLabel: {
                        rotate: 50
                    },
                },
                yAxis: {
                    type: 'value'
                },
                grid: { containLabel: true },
                color: color_set,
                series: data
            }; 

            current_echart.setOption(option);
            CHARTS_LIST.push(current_echart)
        }
    
        function bubble_scatter_line(line_data, bubble_chart_data, chart_div_id)
        {
            // var current_echart = echarts.init(document.getElementById(chart_div_id));

            // option = {
            //     xAxis: {
            //         max: 100,
            //     },
            //     yAxis: {
            //         scale: true,
            //         axisLabel: {
            //             formatter: (function(value) {
            //                 return parseInt(value)
            //             })
            //         }
            //     },
            //     series: [
            //     {
            //         name: 'gt',
            //         data: bubble_chart_data,
            //         type: 'scatter',
            //         symbolSize: function (data) 
            //         {
            //             return data[2];
            //         }
            //     },
            //     {
            //         name: 'regression',
            //         data: line_data,
            //         type: 'line',
            //     }
            //     ]
            // };

            // current_echart.setOption(option);
            // CHARTS_LIST.push(current_echart)
        }
    
    
        
        // **************************************************************************************
        //
        // district page / view
        //
        // **************************************************************************************
        var META_DISTRICTS_SUBURB = {};
        var META_DATA_COMPLETENESS = {"districts": {}, "suburbs": {}};

        var TREE_COUNT = {"districts": {}, "suburbs": {}};
        var CUT_TREE_COUNT = {"districts": {}, "suburbs": {}};

        var GENUS = {"districts": {}, "suburbs": {}};  // with predictions
        var GENUS_CUT = {"districts": {}, "suburbs": {}};  // with predictions
        var AGE_GROUPS = {"districts": {}, "suburbs": {}};  // with predictions
        var AGE_GROUPS_CUT = {"districts": {}, "suburbs": {}};  // with predictions
        var OBJECT_TYPE = {"districts": {}, "suburbs": {}};
        
        function load_district_page_globals()
        {
            get_json_data("meta/districts_suburbs.json", function(json_data) { META_DISTRICTS_SUBURB = json_data; });

            get_json_data("meta/district_data_completeness.json", function(json_data) { META_DATA_COMPLETENESS["districts"] = json_data; });
            get_json_data("meta/suburb_data_completeness.json", function(json_data) { META_DATA_COMPLETENESS["suburbs"] = json_data; });
            get_json_data("districts/tree_count.json", function(json_data) { TREE_COUNT["districts"] = json_data; });
            get_json_data("suburbs/tree_count.json", function(json_data) { TREE_COUNT["suburbs"] = json_data; });
            get_json_data("districts/cut_tree_count.json", function(json_data) { CUT_TREE_COUNT["districts"] = json_data; });
            get_json_data("suburbs/cut_tree_count.json", function(json_data) { CUT_TREE_COUNT["suburbs"] = json_data; });
            get_json_data("districts/genus_with_predictions.json", function(json_data) { GENUS["districts"] = json_data; });
            get_json_data("suburbs/genus_with_predictions.json", function(json_data) { GENUS["suburbs"] = json_data; });
            get_json_data("suburbs/cut_tree_genus_with_predictions.json", function(json_data) { GENUS_CUT["suburbs"] = json_data; });
            get_json_data("districts/age_groups_with_predictions.json", function(json_data) { AGE_GROUPS["districts"] = json_data; });
            get_json_data("suburbs/age_groups_with_predictions.json", function(json_data) { AGE_GROUPS["suburbs"] = json_data; });
            get_json_data("suburbs/cut_tree_age_groups_with_predictions.json", function(json_data) { AGE_GROUPS_CUT["suburbs"] = json_data; });
            get_json_data("districts/object_type.json", function(json_data) { OBJECT_TYPE["districts"] = json_data; });
            get_json_data("suburbs/object_type.json", function(json_data) { OBJECT_TYPE["suburbs"] = json_data; });
        }
        
        function start_district_details_page(district_name)
        {
            ons.notification.toast('Change to details page of ' + district_name, 
            {
                timeout: 500
            });
            
            document.querySelector('#myNavigator').pushPage('district_page.html', {
                data: {"district_name": district_name}
            });
        }

        function create_district_details_charts(district_name)
        {
            // set page text variables to district name
            $(".suburb_name_text_var").each(function() {
                $(this).text(district_name);
            });
            
            // get suburb name list within district
            var current_suburbs = META_DISTRICTS_SUBURB[district_name];
            
            // get current suburb values
            var current_tree_count_suburbs = {};
            var current_cut_tree_count_suburbs = {};
            var current_genus_suburbs = {};
            var current_genus_suburbs_cut = {};
            var current_age_groups_suburbs = {};
            var current_age_groups_suburbs_cut = {};
            var current_object_type_suburbs = {};

            for(var i in current_suburbs)
            {
                s = current_suburbs[i];

                current_tree_count_suburbs[s] = TREE_COUNT.suburbs[s];
                current_cut_tree_count_suburbs[s] = CUT_TREE_COUNT.suburbs[s];
                current_genus_suburbs[s] = GENUS.suburbs[s];
                current_genus_suburbs_cut[s] = GENUS_CUT.suburbs[s];
                current_age_groups_suburbs[s] = AGE_GROUPS.suburbs[s];
                current_age_groups_suburbs_cut[s] = AGE_GROUPS_CUT.suburbs[s];
                current_object_type_suburbs[s] = OBJECT_TYPE.suburbs[s];
            }
            
            create_suburbs_tree_count_data(current_tree_count_suburbs, current_cut_tree_count_suburbs);
            create_suburbs_age_groups(current_age_groups_suburbs, current_age_groups_suburbs_cut);
        }


        // **************
        //
        // **************
        function create_suburbs_tree_count_data(json_data_exist, json_data_cut_down)
        {
            var tmp_district_values = {};
            var data_piechart = []
            var data_cut_down_perc = [];
            
            var tmp_values = [];
            var axis_keys = []
            var existing_values = []
            var cutdown_values = []
            var cutdown_values_district = []
            var cutdown_values_overall = []
            
            var num_all_trees_existing = 0
            var num_all_trees_cut_down = 0
            for(key in json_data_exist)  // same keys in both datasets
            {
                num_all_trees_existing += json_data_exist[key]["absolute"];
                num_all_trees_cut_down += json_data_cut_down[key]["absolute"];
            }

            for(key in json_data_exist)  // same keys in both datasets
            {
                if(key == "unknown")
                    continue;

                try {
                    existing_value_abs = json_data_exist[key]["absolute"];
                } catch {
                    existing_value_abs = 0;
                }

                try {
                    cut_down_value_abs = json_data_cut_down[key]["absolute"];
                } catch {
                    cut_down_value_abs = 0;
                }

                axis_keys.push(key)
                existing_values.push(existing_value_abs);
                cutdown_values.push(cut_down_value_abs);

                try {
                    cutdown_values_district.push({
                        "value": ((cut_down_value_abs/(existing_value_abs + cut_down_value_abs)) * 100).toFixed(2), 
                        "name": key
                    });
                } catch {
                    cutdown_values_district.push({"value": 0, "name": key});
                }
                
                try {
                    cutdown_values_overall.push({"value": ((json_data_cut_down[key]["absolute"]/num_all_trees_cut_down)*100).toFixed(2), "name": key});
                } catch {
                    cutdown_values_overall.push({"value": 0, "name": key});
                }

                try {
                    data_piechart.push({"value": ((json_data_exist[key]["absolute"]/num_all_trees_existing)*100).toFixed(2), "name": key});
                } catch {
                    data_piechart.push({"value": 0, "name": key});
                }

            }

            var data = [];
            data.push({"type": 'bar', "stack": 'suburbs', "data": existing_values});
            data.push({"type": 'bar', "stack": 'suburbs', "data": cutdown_values});


            draw_stacked_bar_chart(data, axis_keys, "overview_suburbs_tree_count_num", ["#2fd93d", "#d95f2f"]);
            draw_pie_chart(data_piechart, "overview_suburbs_tree_count_perc", CHARTS_COLORSET_DEFAULT, true);
        
            draw_pie_chart(cutdown_values_overall, "overview_suburbs_tree_count_perc_overall", CHARTS_COLORSET_DEFAULT, true);
            draw_simple_bar_chart(cutdown_values_district, "overview_suburbs_cut_tree_count_perc_district", CHARTS_COLORSET_BLACK);
        }

        function create_suburbs_age_groups(json_data_exist, json_data_cut_down)
        {
            // *****
            //
            // *****
            for(var i in [json_data_exist, json_data_cut_down])
            {
                var json_data = [json_data_exist, json_data_cut_down][i];
                var div_name_modifier = "";
                if(i==1)
                    div_name_modifier = "cut_trees_";

                var axis_keys = [];
                var age_group_vals_num = {"0": [], "1": [], "2": [], "unknown": []};
                var age_group_vals_perc = {"0": [], "1": [], "2": [], "unknown": []};
                
                for(key in json_data)  // same keys in both datasets
                {
                    if(key == "unknown")
                        continue;
                    
                    axis_keys.push(key)
                    var age_keys = ["0", "1", "2", "unknown"];
                    age_keys.forEach(function (agekey, i) 
                    {
                        var age_value_num = 0;
                        var age_value_perc = 0;
                        if(typeof(json_data[key][agekey]) !== "undefined")
                        {
                            age_value_num = json_data[key][agekey]["absolute"];
                            age_value_perc = (json_data[key][agekey]["percentage"] * 100).toFixed(0);
                        }
                        age_group_vals_num[agekey].push(age_value_num);
                        age_group_vals_perc[agekey].push(age_value_perc);
                    });
                }
                var data_num = [];
                var data_perc = [];
                for(var i in Object.values(age_group_vals_num))  // i is corresponding
                {
                    data_num.push({"type": 'bar', "stack": 'districts', "data": Object.values(age_group_vals_num)[i]});
                    data_perc.push({"type": 'bar', "stack": 'districts', "data": Object.values(age_group_vals_perc)[i]});
                }
                draw_stacked_bar_chart(data_num, axis_keys, "overview_suburbs_" + div_name_modifier + "age_groups_num", CHARTS_COLORSET_AGE_GROUPS);
                draw_stacked_bar_chart(data_perc, axis_keys, "overview_suburbs_" + div_name_modifier + "age_groups_perc", CHARTS_COLORSET_AGE_GROUPS);
            }
        }
    
    </script>
</body>
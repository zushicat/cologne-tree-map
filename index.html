<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <link rel="shortcut icon" href="src/tree_favicon.png">

    <!-- mapbox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css' rel='stylesheet' />

    <!-- mapbox geocoder -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css"/>
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>


    <!-- <script src="lib/dom-to-image.min.js"></script> -->
    <script src="lib/echarts.min.js"></script>
    <script src="lib/jquery-3.3.1.min.js"></script>
    <!-- <script src="lib/js.cookie.min.js"></script> -->

    <!-- onsen -->
    <link rel="stylesheet" href="lib/OnsenUI-dist-2.10.10/css/onsenui.css">
    <link rel="stylesheet" href="lib/OnsenUI-dist-2.10.10/css/onsen-css-components.min.css">
    <script src="lib/OnsenUI-dist-2.10.10/js/onsenui.min.js"></script>
 
    <!-- jszip -->
    <!-- https://stuk.github.io/jszip/ -->
    <script src="lib/jszip/jszip.min.js"></script>
    <script src="lib/jszip/jszip-utils.min.js"></script>

    <!-- ! TMP ! client-sided utm -> lat/lng projection -->
    <!-- https://stackoverflow.com/a/18621244 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>

    <style>
        /* ************************** */
        /* page */
        /* ************************** */
        body
        {
            font-weight: 400;
            font-size: 17px;
            line-height: 32px;
        }
        .page__background { background-color: #fff; }

        /* ************************** */
        /* content container */
        /* ************************** */
        .content_container { margin: 20px; }

        /* ************************** */
        /* map */
        /* ************************** */
        #tree_map {
            width: 100%;
            height: 500px;
            background-color: #ccc;
        }

        /* ************************** */
        /* widgets */
        /* ************************** */
        .widget-head {
            font-size: x-large;
            font-weight: bold;
        }

        .widget-content {
            padding-top: 20px;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }

        .half_page_width, .full_page_width {
            width: 800px;
            height: 800px;
        }

        .echart_col {
            text-align: -webkit-center;
        } 

        canvas {
            margin: 0 auto;  /* center echart canvas in div */
        }
    </style>
</head>

<body>
    <!-- ************************************* -->
    <!-- modal on init -->
    <!-- ************************************* -->
    <ons-modal direction="up">
        <div style="text-align: center">
        <ons-icon icon="md-spinner" size="60px" spin></ons-icon>
        </div>
    </ons-modal>

    <!-- ************************************* -->
    <!-- start navigator -->
    <!-- ************************************* -->
    <ons-navigator id="myNavigator" page="home_splitter.html"></ons-navigator>
    <!-- <ons-navigator id="myNavigator" page="map_page.html"></ons-navigator> -->

    <!-- ************************************* -->
    <!-- home_splitter: menu and venue_list -->
    <!-- ************************************* -->
    <template id="home_splitter.html">
        <ons-page id="home_splitter">
            <ons-splitter>
                <ons-splitter-side id="side_menu" page="menu.html" side="left" width="80%" collapse></ons-splitter-side>
                <ons-splitter-content id="content" page="map_page.html"></ons-splitter-content>
            </ons-splitter>
        </ons-page>
    </template>

    <!-- ************************************* -->
    <!-- side menu -> map navigation -->
    <!-- ************************************* -->
    <template id="menu.html">
        <ons-page id="menu">
            <!-- ********************** -->
            <!--  map navigation  -->
            <!-- ********************** -->
            <div class="content_container" id="map_interaction_container">
                <p class="widget-head">Tree map display options</p>
                <ons-list>
                    <!-- ***** -->
                    <ons-list-item tappable>
                        <ons-row>
                            <ons-col>
                                <p>Select age groups of trees</p>
                            </ons-col>
                        </ons-row>

                        <ons-row>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="0" class="nav_age_group_checkbox" input-id="nav_filter_age_group_0" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_0" class="center">
                                    <= 25 years
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="1" class="nav_age_group_checkbox" input-id="nav_filter_age_group_1" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_1" class="center">
                                    26-40 years
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="2" class="nav_age_group_checkbox" input-id="nav_filter_age_group_2" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_2" class="center">
                                    > 40 years
                                </label>
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-checkbox data-agegroup="3" class="nav_age_group_checkbox" input-id="nav_filter_age_group_3" checked></ons-checkbox>
                                </label>
                                <label for="nav_filter_age_group_3" class="center">
                                    unknown
                                </label>
                            </ons-col>
                        </ons-row>
                    </ons-list-item>

                    <!-- ***** -->
                    <ons-list-item>
                        <ons-row>
                            <ons-col>
                                <p>Display options</p>
                            </ons-col>
                        </ons-row>

                        <ons-row>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-radio name="nav_switch_map_style" value="streets" input-id="nav_switch_map_style_streets" checked></ons-radio>
                                    Streets
                                </label>
                                <!-- <label for="nav_switch_map_style_streets" class="center">
                                    Streets
                                </label> -->
                            </ons-col>
                            <ons-col width="130px">
                                <label class="left">
                                    <ons-radio name="nav_switch_map_style" value="satellite" input-id="nav_switch_map_style_satellite"></ons-radio>
                                    Satellite
                                </label>
                                <!-- <label for="nav_switch_map_style_streets" class="center">
                                    Satellite
                                </label> -->
                            </ons-col>

                            <ons-col width="200px">
                                <label class="left">
                                    <ons-checkbox input-id="nav_show_district_borders" checked></ons-checkbox>
                                </label>
                                <label for="nav_show_district_borders" class="center">
                                    Show suburb borders
                                </label>
                            </ons-col>
                        </ons-row>
                    </ons-list-item>

                    <!-- ***** -->
                    <!-- <ons-list-item id="nav_district_button_list_container" tappable expandable>
                        Show trees in selected districts
                        <div class="expandable-content"> -->
                            <!-- dynamically created district list as 3x3 grid: build_district_selection_grid() -->
                            <!-- hardcoded in fct: start with restricted tree display of Innenstadt and Ehrendfeld -->
                            <!-- <ons-row id="nav_selected_districts_container"></ons-row> -->
                        <!-- </div>
                    </ons-list-item> -->

                    <!-- ***** -->
                    <ons-list-item>
                        <ons-row>
                            <ons-col>
                                <p>Select districts with displayed trees</p>
                            </ons-col>
                        </ons-row>

                        <ons-row id="nav_selected_districts_container">
                        </ons-row>
                    </ons-list-item>
                </ons-list>
            </div>
        </ons-page>
    </template>

    
    <!-- ************************************* -->
    <!-- map section -->
    <!-- ************************************* -->
    <template id="map_page.html">
        <ons-page id="map_page">
            <ons-toolbar>
                <!-- <div class="left">
                    <ons-toolbar-button onclick="fn.open()">
                        <ons-icon icon="md-menu"></ons-icon>
                    </ons-toolbar-button>
                    Map Options
                </div> -->
                <div class="center">
                    Cologne Tree Map
                </div>
            </ons-toolbar>

            <!-- ********************** -->
            <!-- the map -->
            <!-- ********************** -->
            <div id="tree_map">
                <!-- open map options button -->
                <ons-fab style="position: absolute; bottom: 40px; right: 40px;" onclick="fn.open()">
                    <ons-icon icon="md-plus"></ons-icon>
                </ons-fab>
            </div>
            

            <!-- ********************** -->
            <!-- content -->
            <!-- ********************** -->
            <div class="content_container">
                <!-- ********************** -->
                <!-- some explanation -->
                <!-- ********************** -->
                <p>
                    Visualization of Cologne Tree Data. <b>As of now, this is work in progress.</b><br>
                    Check out <a href="https://github.com/zushicat/cologne-trees-REST-API" target="_blank">this github repository</a> for detailled information about the used data.
                </p>

                <!-- ******************************************** -->
                <!-- overview charts -->
                <!-- ******************************************** -->

                <!-- ********************** -->
                <!-- existing / cut -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Overall Numbers</p>
                    <p>Dataset Overview</p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>How many trees do exist or are cut down since 2017?</p>
                            <div id="overview_tree_count" class="echart half_page_width"></div>
                            
                            <!-- map percentage in text -->
                            <p style="text-align: left;">
                                <b><span id="overview_percentage_cut_down"></span>%</b> of trees in Cologne are presumably cut down between 2017 and 2020.<br>
                                Those trees appear in the 2017 dataset but not in the 2020 dataset (of both cleaned up dataset versions).
                            </p>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>How complete is the original data?</p>
                            <div id="overview_data_completeness" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                </div>

                <!-- ********************** -->
                <!-- pie charts age groups -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Age groups</p>
                    <p>City trees are usually planted at an age between 8 - 12 years.</p>
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Existing trees</p>
                            <div id="overview_agegroups_tree_count" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees</p>
                            <div id="overview_agegroups_cut_tree_count" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                </div>

                <!-- ********************** -->
                <!-- pie charts genus -->
                <!-- ********************** -->
                <div class="widget-content">
                    <p class="widget-head">Genus</p>
                    <!-- <p>City trees are usually planted at an age between 8 - 12 years.</p> -->
                    <ons-row>
                        <ons-col class="echart_col">
                            <p>Existing trees by genus (>= 1.5% occurance in this cohort)</p>
                            <div id="overview_genus_tree_count" class="echart half_page_width"></div>
                        </ons-col>
                        <ons-col class="echart_col">
                            <p>Cut down trees by genus (>= 1.5% occurance in this cohort)</p>
                            <div id="overview_genus_cut_tree_count" class="echart half_page_width"></div>
                        </ons-col>
                    </ons-row>
                </div>

                <!-- ********************** -->
                <!-- district lists |-> individual district charts -->
                <!-- ********************** -->
                <!-- <div class="widget-content">
                    <p class="widget-head">Districts of Cologne, Germany</p>
                    <p>Something something bla bla blub.</p>
                    <br>
                    <ons-list>
                        <ons-lazy-repeat id="infinite-district-list"></ons-lazy-repeat>
                    </ons-list>
                </div> -->
            </div>

        </ons-page>
    </template>


    <!-- ************************************* -->
    <!-- script section -->
    <!-- ************************************* -->
    <script>
        // prevent caching of once loaded json file
        $(document).ready(function() 
        {
            $.ajaxSetup({ cache: false });
        });

        // ****
        // globals
        // ****
        WINDOW_WIDTH = $(window).width(); // init width
        
        // ************
        // map globals
        // ************
        var MAP;

        var TREE_DATA_BY_ID = {};
        var TREE_MAP_FEATURES = {};  // object (by district if) of lists of trees
        var CUT_TREE_MAP_FEATURES = {};  // object (by district id) of lists of cut trees

        var DISTRICT_MAP_FEATURES = [];
        var SUBURB_LIST = []

        var DISPLAY_DISTRICT_BORDERS = false;
        var DISPLAY_TREES_DISTRICTS = [];
        var DISPLAY_AGE_GROUPS = [];

        var DISTRICT_NAMES_BY_ID = {
            "1": "Innenstadt",
            "2": "Rodenkirchen",
            "3": "Lindenthal",
            "4": "Ehrenfeld",
            "5": "Nippes",
            "6": "Chorweiler",
            "7": "Porz",
            "8": "Kalk",
            "9": "Mülheim"
        }

        // ************
        // charts globals
        // ************
        // var API_BASE_URL = "http://localhost/cologne-trees-static-API/endpoints/"  // local debug
        var API_BASE_URL = "https://zushicat.github.io/cologne-trees-static-API/endpoints/"

        var CHARTS_COLORSET_AGE_GROUPS = ["#c3eb34", "#7aeb34", "#2ed93c", "#4f96c9"]
        var CHARTS_COLORSET_DEFAULT = ["#ccc", "#bbb", "#aaa", "#999", "#888", "#777", "#666", "#555", "#444", "#333", "#222", "#111", "#000"]
        var CHARTS_COLORSET_BLACK = ["#222"]

        var CHARTS_LIST = [];

        // *************************************************************
        // side menu
        // *************************************************************
        window.fn = {};

        window.fn.open = function() 
        {
            var menu = document.getElementById('side_menu');
            menu.open();
        };

        window.fn.load = function(page) 
        {
            var content = document.getElementById('map_page');
            var menu = document.getElementById('side_menu');
            
            content.load(page).then(menu.close.bind(menu));
        };

        // *************************************************************
        // event listener (on start)
        // *************************************************************
        document.addEventListener('init', function(event) 
        {
            // document.querySelector('ons-modal').show();
            // console.log(event.target)

            if(event.target.matches("#map_page")) //('#map_page')) 
            {
                //console.log("map page")
                set_widgets_size();  // init echart widgets width
            }

            if(event.target.matches("#menu")) //('#map_page')) 
            {
                //console.log("menu page")
            }

            if(event.target.matches('#home_splitter'))   //("#home_splitter")) //('#map_page')) 
            {
                //console.log("splitter")
                $.ajaxSetup({ cache: false });  // prevent caching of once loaded json file
                
                load_tree_data(function()
                {
                    console.log("---- data loaded ----");
                    build_district_selection_grid(function()
                    {
                        add_navigation_elements_event_handler();
                        //display_map_data();
                    });
                });

                create_main_page_overview_charts();
            }
        });

        // *************************************************************
        // set echarts widget size and resize event
        // *************************************************************
        function set_widgets_size()
        {
            $(".half_page_width").css("width", parseInt( (WINDOW_WIDTH/2) * 0.9 ));
            $(".full_page_width").css("width", parseInt( WINDOW_WIDTH * 0.9 ));

            $(".half_page_width").css("height", parseInt( ((WINDOW_WIDTH/2) * 0.9) * 0.7 ));
            $(".full_page_width").css("height", ( (WINDOW_WIDTH * 0.9) * 0.7 ));


            for(var i in CHARTS_LIST)
            {
                CHARTS_LIST[i].resize();
            }
        }

        window.onresize = function(event) 
        {
            if(typeof($(window).width()) != "undefined")
                WINDOW_WIDTH = $(window).width();
            set_widgets_size();
        };
        
        // **************************************************************
        //
        // Map
        //
        // **************************************************************
        
        // *************************************************************
        // event listener: navigation elements
        // *************************************************************
        function add_navigation_elements_event_handler()
        {
            // **********
            // expandabale list for districts is default expanded
            // **********
            //document.querySelector("#nav_district_button_list_container").showExpansion()

            // **********
            // toggle district border display
            // **********
            var checkbox_selector_district_borders = document.querySelector("#nav_show_district_borders");
            DISPLAY_DISTRICT_BORDERS = checkbox_selector_district_borders.checked;
            
            // add event
            checkbox_selector_district_borders.addEventListener('click', function()
            {
                DISPLAY_DISTRICT_BORDERS = this.checked;
                toogle_display_district_polygons();
            });
            
            // **********
            // toggle district display
            // **********
            var checkbox_selector_district_tree_display = document.querySelectorAll('.nav_district_trees_checkbox')
            for (var i = 0; i < checkbox_selector_district_tree_display.length; i++) 
            {
                // init display of trees in districts
                if(checkbox_selector_district_tree_display[i].getAttribute("checked") != null) 
                    DISPLAY_TREES_DISTRICTS.push(checkbox_selector_district_tree_display[i].getAttribute("data-district"));

                // add event
                checkbox_selector_district_tree_display[i].addEventListener('click', function()
                {
                    if(this.checked == true)
                    {
                        DISPLAY_TREES_DISTRICTS.push(this.getAttribute("data-district"))
                    }
                    else  // remove de-selected from global list
                    {
                        for(var j = 0; j < DISPLAY_TREES_DISTRICTS.length; j++)
                            if(DISPLAY_TREES_DISTRICTS[j] === this.getAttribute("data-district"))
                                DISPLAY_TREES_DISTRICTS.splice(j, 1); 
                    }
                    toogle_display_trees_district();
                });
            }

            // **********
            // switch map style
            // **********
            var bla = document.querySelectorAll('input[name="nav_switch_map_style"]')
            for (var i = 0; i < bla.length; i++) 
            {
                bla[i].addEventListener('click', function()
                {
                    console.log(this.value);
                    if(this.value == "satellite")
                        MAP.setStyle("mapbox://styles/mapbox/satellite-v9");
                    else
                        MAP.setStyle("mapbox://styles/zushicat/ckbcadygg11ao1irxsfxy1jzx")
                })
            };

            // **********
            // filter age group display
            // **********
            var checkbox_selector_age_group_display = document.querySelectorAll('.nav_age_group_checkbox')
            for (var i = 0; i < checkbox_selector_age_group_display.length; i++) 
            {
                // init
                if(checkbox_selector_age_group_display[i].getAttribute("checked") != null) 
                    DISPLAY_AGE_GROUPS.push(checkbox_selector_age_group_display[i].getAttribute("data-agegroup"));
                
                checkbox_selector_age_group_display[i].addEventListener('click', function()
                {
                    if(this.checked == true)
                    {
                        DISPLAY_AGE_GROUPS.push(this.getAttribute("data-agegroup"))
                    }
                    else  // remove de-selected from global list
                    {
                        for(var j = 0; j < DISPLAY_AGE_GROUPS.length; j++)
                            if(DISPLAY_AGE_GROUPS[j] === this.getAttribute("data-agegroup"))
                                DISPLAY_AGE_GROUPS.splice(j, 1); 
                    }
                    filter_display_age_groups();
                });
            }
        }

        // **************************************************************
        // navigation elements
        // **************************************************************
        function build_district_selection_grid(callback)
        {
            j=-1
            for(var i in SUBURB_LIST)
            {
                if(i%3 == 0)
                {
                    j++;
                    var tmp_list = $('<ons-col><ons-list modifier="noborder"></ons-list></ons-col>');
                    $("ons-list", tmp_list).attr("id", "nav_district_trees_grid_" + j);
                    $("#nav_selected_districts_container").append(tmp_list);
                }
                
                var tmp_checked = "";
                if(["1"].includes(SUBURB_LIST[i]))  // Innenstadt
                    tmp_checked = "checked";

                var tmp_element = 
                $('<ons-list-item tappable  modifier="nodivider">\
                    <label class="left">\
                        <ons-checkbox data-district="' + SUBURB_LIST[i] + '" class="nav_district_trees_checkbox" input-id="nav_district_trees_element_' + i + '" ' + tmp_checked + '></ons-checkbox>\
                    </label>\
                    <label for="nav_district_trees_element_' + i + '" class="center">' + DISTRICT_NAMES_BY_ID[SUBURB_LIST[i]] + '</label>\
                </ons-list-item>');

                $("#nav_district_trees_grid_" + j).append(tmp_element)
            }
            callback()
        }

        // **************************************************************
        //
        // **************************************************************
        function load_tree_data(callback)
        {
            var count = 0;

            // loading a zip file with a progress callback
            JSZipUtils.getBinaryContent("src/data/app_data.zip", 
            {
                progress: function (e) {
                    // console.log(event.percent + "% of " + event.path+ " loaded")
                },
                callback: function (err, data) 
                {
                    if(err) {
                        throw err; // or handle the error
                    }
                    var zip = new JSZip();
                    zip.loadAsync(data).then(function(contents) 
                    {
                        Object.keys(contents.files).forEach(function(filename) 
                        {
                            zip.file(filename).async('string').then(function(content) 
                            {
                                if(filename == "trees_cologne_merged_reduced.jsonl")
                                {
                                    tree_data_lines = content.split("\n");
                                    for(var i in tree_data_lines)
                                    {
                                        try 
                                        {
                                            var tree_data = JSON.parse(tree_data_lines[i]);
                                        
                                            var tree_id = tree_data.tree_id;
                                            var lat = tree_data.lat;
                                            var lng = tree_data.lng;

                                            var genus = tree_data.genus;
                                            var in_dataset_2020 = tree_data.in_dataset_2020
                                            
                                            var district_number = tree_data.district_number;
                                            if(district_number == null)
                                                continue;
                                            district_number = district_number.toString();
                                            
                                            // *****
                                            // age
                                            var age_group = null;
                                            if(tree_data.age_group != null)
                                                age_group = tree_data.age_group;
                                            else
                                                age_group = 3;  // unknown
                                            
                                            if(TREE_MAP_FEATURES[district_number] == null)
                                                TREE_MAP_FEATURES[district_number] = []
                                            if(CUT_TREE_MAP_FEATURES[district_number] == null)
                                                CUT_TREE_MAP_FEATURES[district_number] = []
                                            
                                            var tree_feature = 
                                            {
                                                "type": "Feature",
                                                "geometry": 
                                                {
                                                    "type": "Point",
                                                    "coordinates": [lng, lat]
                                                },
                                                "properties": 
                                                {
                                                    "id": tree_id,
                                                    "age_group": age_group,
                                                    "genus": genus,
                                                    "in_dataset_2020": in_dataset_2020
                                                }
                                            }

                                            if(in_dataset_2020 == true)
                                            {
                                                TREE_DATA_BY_ID[tree_id] = tree_data;
                                                TREE_MAP_FEATURES[district_number].push(tree_feature);
                                            }
                                            else
                                            {
                                                TREE_DATA_BY_ID[tree_id] = tree_data;
                                                CUT_TREE_MAP_FEATURES[district_number].push(tree_feature);
                                            }
                                        }
                                        catch { console.log("!!!!") }
                                    }
                                    count++;
                                    if(count==2)
                                        callback()
                                }
                                if(filename == "cologne_districts_polygons.json")
                                {
                                    var suburb_data = JSON.parse(content).features;
                                    
                                    for(var i in suburb_data)
                                    {
                                        var suburb_id = suburb_data[i].properties.NUMMER;
                                        var suburb_name = suburb_data[i].properties.NAME;

                                        var district_id = suburb_data[i].properties.NR_STADTBEZIRK;
                                        var district_name = suburb_data[i].properties.STADTBEZIRK;

                                        var coordinates = suburb_data[i].geometry.coordinates;
                                        
                                        
                                        tmp = {
                                            "type": "Feature",
                                            "geometry": 
                                            {
                                                "type": "Polygon",
                                                "coordinates": coordinates
                                            },
                                            "properties": {
                                                "id": district_id,
                                                "title": district_name
                                            }
                                        }
                                        DISTRICT_MAP_FEATURES.push(tmp)
                                        
                                        if(SUBURB_LIST.includes(district_id) == false)
                                            SUBURB_LIST.push(district_id);
                                    }
                                    count++;
                                    if(count==2)
                                        callback()
                                }
                            })
                        })
                    })
                }
            });
        }

        // **************************************************************
        //
        // **************************************************************
        function init_map()
        {
            var baseLayers = 
            [
                { label: 'streets', style: "mapbox://styles/mapbox/satellite-v9" }, 
                { label: 'satellite', style: "mapbox://styles/zushicat/ckbcadygg11ao1irxsfxy1jzx" }
            ];

            mapboxgl.accessToken = 'pk.eyJ1IjoienVzaGljYXQiLCJhIjoiY2p1Y2o0bGR6MGNnZjRka2IzcmNraGtyZSJ9.wBS9jxpUT9vWhsCiWF_z5w';
            
            // *********
            // init map
            MAP = new mapboxgl.Map(
            {
                container: 'tree_map',
                style: 'mapbox://styles/zushicat/ckbcadygg11ao1irxsfxy1jzx', // stylesheet location
                center: [6.953101, 50.935173], // starting position [lng, lat]
                zoom: 13 // starting zoom
            });

            // *********
            // add geoccoder search
            MAP.addControl(new MapboxGeocoder(
            {
                accessToken: mapboxgl.accessToken,
                countries: 'de',  // limit results to Australia
                bbox: [6.731135, 50.860533, 7.225520, 51.032067],  // further limit results to geographic bounds
                
                // apply a client side filter to further limit results to those strictly within
                // the New South Wales region
                filter: function(item) 
                {
                    // console.log(item)
                    // returns true if item contains New South Wales region
                    return item.context.map(function(i) {
                        // id is in the form {index}.{id} per https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                        // this example attempts to find the `region` named `New South Wales`
                        return (
                            i.id.split('.').shift() === 'region' &&
                            i.text === 'Nordrhein-Westfalen'
                        );
                    }).reduce(function(acc, cur) 
                    {
                        return acc || cur;
                    });
                },
                mapboxgl: mapboxgl
            }));

            // ***
            // toggle full screen
            MAP.addControl(new mapboxgl.FullscreenControl());

            // ***
            // disable map zoom when using scroll
            MAP.scrollZoom.disable();

            // ***
            // Add zoom and rotation controls to the map
            // disable map rotation using navigation
            MAP.addControl(new mapboxgl.NavigationControl({
                showCompass: false,
                showZoom: true
            }));

            // ***
            // disable map rotation 
            MAP.dragRotate.disable(); // using right click + drag
            MAP.touchZoomRotate.disableRotation(); // using touch rotation gesture
        }

        // **************************************************************
        //
        // **************************************************************
        function create_tree_layer()
        {
            for(var district_number in TREE_MAP_FEATURES)
            {
                if(district_number == null)
                    continue
                
                MAP.addSource('trees_' + district_number, 
                {
                    'type': 'geojson',
                    'data': 
                    {
                        'type': 'FeatureCollection',
                        'features': TREE_MAP_FEATURES[district_number]
                    }
                });

                // init visibility
                var layer_visibility = "none";
                if(DISPLAY_TREES_DISTRICTS.includes(district_number) == true)
                    layer_visibility = "visible";

                MAP.addLayer(
                {
                    "id": 'all_trees_layer_' + district_number,
                    "type": 'circle',
                    "source": 'trees_' + district_number,
                    "paint": 
                    {
                        "circle-radius": {
                            "base": 1.75,
                            "stops": [
                                [12, 1],
                                [22, 100]
                            ]
                        },
                        "circle-opacity": [
                            'interpolate',
                            ['exponential', 0.5],
                            ['zoom'],
                            12,
                            1.0,
                            22,
                            0.5
                        ],
                        //'circle-color': "#3db023",
                        // color circles by age_group of trees, using a match expression
                        // https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match
                        'circle-color': [
                        'match',
                        ['get', 'age_group'],
                        0,
                        "#c3eb34",
                        1,
                        "#7aeb34",
                        2,
                        "#2ed93c",
                        3,
                        "#4f96c9", 
                        /* other */ "#ff0000"
                        ]
                    },
                    'layout': 
                    {
                        'visibility': layer_visibility
                    },
                });
            }
        }

        function create_cut_tree_layer()
        {
            for(var district_number in CUT_TREE_MAP_FEATURES)
            {
                if(district_number == null)
                    continue

                MAP.addSource('cut_trees_' + district_number, 
                    {
                        'type': 'geojson',
                        'data': 
                        {
                            'type': 'FeatureCollection',
                            'features': CUT_TREE_MAP_FEATURES[district_number]
                        }
                    });
                
                // init visibility
                var layer_visibility = "none";
                if(DISPLAY_TREES_DISTRICTS.includes(district_number) == true)
                    layer_visibility = "visible";
                
                
                MAP.addLayer(
                {
                    "id": "cut_trees_layer_" + district_number,
                    "type": "circle",
                    "source": "cut_trees_" + district_number,
                    "paint": 
                    {
                        "circle-radius": {
                            "base": 1.75,
                            "stops": [
                                [12, 1],
                                [22, 100]
                            ]
                        },
                        "circle-opacity": [
                            'interpolate',
                            ['exponential', 0.5],
                            ['zoom'],
                            12,
                            1.0,
                            22,
                            0.5
                        ],
                        "circle-color": "#ff0000",
                    },
                    'layout': 
                    {
                        'visibility': layer_visibility
                    },
                });
            }
        }

        function create_district_polygon_layer()
        {
            // MAP.on('load', function() 
            // {
                MAP.addSource('districts', 
                {
                    'type': 'geojson',
                    'data': 
                    {
                        'type': 'FeatureCollection',
                        'features': DISTRICT_MAP_FEATURES
                    }
                });

                // init visibility
                var layer_visibility = "none";
                if(DISPLAY_DISTRICT_BORDERS == true)
                    layer_visibility = "visible";

                MAP.addLayer(
                {
                    'id': 'districts_layer',
                    'type': 'line',
                    'source': 'districts',
                    'layout': 
                    {
                        // make layer visible by default
                        'visibility': layer_visibility,
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                    'line-color': '#fc8403',
                    'line-width': 1
                    }
                });
            // });
        }
        
        
        // **************************************************************
        // toggle map display from selection
        // **************************************************************
        function toogle_display_district_polygons()
        {
            var map_layer_id = "districts_layer";
            
            if(DISPLAY_DISTRICT_BORDERS == false)
                MAP.setLayoutProperty(map_layer_id, "visibility", "none");
            else 
                MAP.setLayoutProperty(map_layer_id, "visibility", "visible");
        }

        function toogle_display_trees_district()
        {
            var map_layer = MAP.getStyle().layers;

            for(var i in map_layer)
            {
                if(map_layer[i].id.indexOf("all_trees_layer_") == -1 && map_layer[i].id.indexOf("cut_trees_layer_") == -1)
                    continue
                
                if(map_layer[i].id.indexOf("all_trees_layer_") != -1)
                {
                    var current_district_num = map_layer[i].id.replace("all_trees_layer_", "");
                    if(DISPLAY_TREES_DISTRICTS.includes(current_district_num))
                        MAP.setLayoutProperty(map_layer[i].id, "visibility", "visible");
                    else
                        MAP.setLayoutProperty(map_layer[i].id, "visibility", "none");
                }

                if(map_layer[i].id.indexOf("cut_trees_layer_") != -1)
                {
                    var current_district_num = map_layer[i].id.replace("cut_trees_layer_", "");
                    if(DISPLAY_TREES_DISTRICTS.includes(current_district_num))
                        MAP.setLayoutProperty(map_layer[i].id, "visibility", "visible");
                    else
                        MAP.setLayoutProperty(map_layer[i].id, "visibility", "none");
                }
            }

            // for(var i in DISPLAY_TREES_DISTRICTS)
            // {
            //     var map_layer_id = "all_trees_layer_" + DISPLAY_TREES_DISTRICTS[i];
            //     MAP.setLayoutProperty(map_layer_id, "visibility", "visible");
            // }
        }

        // **************************************************************
        // filter selection
        // **************************************************************
        function filter_display_age_groups()
        {
            var tmp_filtered = [];
            for(var i in DISPLAY_AGE_GROUPS)
                tmp_filtered.push(parseInt(DISPLAY_AGE_GROUPS[i]))
            
            for(var i in SUBURB_LIST)
            {
                var tmp_layer = "all_trees_layer_" + SUBURB_LIST[i]
                MAP.setFilter(tmp_layer, ['match', ['get', 'age_group'], tmp_filtered, true, false]);
            }
        }

        // **************************************************************
        //
        // **************************************************************
        function display_map_data()
        {
            console.log("---- do map stuff ----");
            
            init_map();

            MAP.on('style.load', function() 
            {
                create_district_polygon_layer();
                create_tree_layer();
                create_cut_tree_layer();

                MAP.on('sourcedata', function(e) 
                {
                    show_modal = e.isSourceLoaded;
                    if (e.isSourceLoaded) 
                    {
                        // console.log("----> HIDE MODAL");
                        // document.querySelector('ons-modal').hide();
                    }
                    else
                    {
                        // console.log("----> SHOW MODAL");
                        // document.querySelector('ons-modal').show();
                    }
                });
            });
        }
    
    

        // **************************************************************
        //
        // Charts |-> map page
        //
        // **************************************************************
        function get_json_data(endpoint, callback)
        {
            $.ajax(
            {
                url: API_BASE_URL + endpoint,
                success: function(data)
                {
                    callback(data);
                }
            });
        }

        function create_main_page_overview_charts()
        {
            // ***
            // data completeness
            get_json_data("meta/data_completeness.json", function(json_data)
            {
                // console.log(json_data);
                var data = [];
                for(key in json_data)
                {
                    var value = json_data[key]["mean"];
                    data.push({"value": value, "name": key.replace(/_/g, " ")});
                }
                draw_simple_bar_chart(data, "overview_data_completeness", CHARTS_COLORSET_BLACK)
            });

            // ***
            // overall count
            get_json_data("meta/overall_tree_count.json", function(json_data)
            {
                // console.log(json_data);
                var data = [];
                for(key in json_data)
                {
                    if(key == "percentage_cut_down_since_2017")
                    {
                        $("#overview_percentage_cut_down").text(parseInt(json_data[key] * 100))
                        continue;
                    }

                    var value = json_data[key];
                    data.push({"value": value, "name": key.replace(/_/g, " ")});
                }
                draw_simple_bar_chart(data, "overview_tree_count", CHARTS_COLORSET_BLACK)
            });

            // *********
            // age groups
            // *********
            // age groups |-> count (existing) trees
            get_json_data("agegroups/tree_count_with_predictions.json", function(json_data)
            {
                var data = [];
                for(key in json_data)
                {
                    var value = json_data[key]["absolute"];
                    substitute_key = {
                        "unknown": "unknown", 
                        "0": "<= 25", 
                        "1": "26 - 40", 
                        "2": "> 40"
                    }
                    
                    key = substitute_key[key.toString()]
                    
                    data.push({"value": value, "name": key});
                }
                draw_pie_chart(data, "overview_agegroups_tree_count", CHARTS_COLORSET_AGE_GROUPS)
            })

            // ***
            // age groups |-> count cut trees
            get_json_data("agegroups/cut_tree_count_with_predictions.json", function(json_data)
            {
                var data = [];
                for(key in json_data)
                {
                    var value = json_data[key]["absolute"];
                    substitute_key = {
                        "unknown": "unknown", 
                        "0": "<= 25", 
                        "1": "26 - 40", 
                        "2": "> 40"
                    }
                    
                    key = substitute_key[key.toString()]
                    
                    data.push({"value": value, "name": key});
                }
                draw_pie_chart(data, "overview_agegroups_cut_tree_count", CHARTS_COLORSET_AGE_GROUPS)
            })
        
            // *********
            // genus
            // *********
            // genus |-> count (existing) trees
            get_json_data("meta/genus_name_german.json", function(json_data_names)
            {
                get_json_data("genus/tree_count_with_prediction.json", function(json_data)
                {
                    var data = [];
                    for(key in json_data)
                    {
                        var name_german = json_data_names[key];
                        
                        var abs_value = json_data[key]["absolute"];
                        var perc_value = json_data[key]["percentage"];

                        if(perc_value < 0.02)
                            continue;
                        
                        if(typeof(name_german) !== "undefined")
                            key = name_german["name_german"];
                        
                        data.push({"value": abs_value, "name": key});
                    }
                    draw_pie_chart(data, "overview_genus_tree_count", CHARTS_COLORSET_DEFAULT, true)
                });

                get_json_data("genus/cut_tree_count_with_prediction.json", function(json_data)
                {
                    var data = [];
                    for(key in json_data)
                    {
                        var name_german = json_data_names[key];
                        
                        var abs_value = json_data[key]["absolute"];
                        var perc_value = json_data[key]["percentage"];

                        if(perc_value < 0.015)
                            continue;
                        
                        if(typeof(name_german) !== "undefined")
                            key = name_german["name_german"];
                        
                        data.push({"value": abs_value, "name": key});
                    }
                    draw_pie_chart(data, "overview_genus_cut_tree_count", CHARTS_COLORSET_DEFAULT, true)
                });
            })
        }

        // *****
        // draw widgets
        // *****
        function draw_pie_chart(data, chart_div_id, color_set, sorted_data) 
        {
            function get_series_data(current_data)
            {
                var processed_data = current_data; // unsorted
                if(sorted_data == true)
                {
                    processed_data = processed_data.sort(function (a, b) { return a.value - b.value; });
                }
                return processed_data;
            }


            var current_echart = echarts.init(document.getElementById(chart_div_id));
            
            option = {
                tooltip: {
                    trigger: 'item',
                    formatter: "{b}<br/>absolute number: {c}"
                },
                grid: { containLabel: true },
                color: color_set,
                series: [
                    {
                        name:'Label sale',
                        type:'pie',
                        radius: ['40%', '70%'],
                        label: {normal: {textStyle: { color: '#333' }}},
                        labelLine: {normal: {lineStyle: { color: '#333'}}},
                        data: get_series_data(data),  //data, //data.sort(function (a, b) { return a.value - b.value; }) else data,
                    }
                ]
            };
            
            current_echart.setOption(option);
            CHARTS_LIST.push(current_echart);
        }

        function draw_simple_bar_chart(data, chart_div_id, color_set)
        {
            var current_echart = echarts.init(document.getElementById(chart_div_id));

            keys = [];
            values = [];
            for (var i in data) 
            {
                keys.push(data[i].name)
                values.push(data[i].value)
            }

            option = {
                xAxis: {
                    type: 'category',
                    data: keys,
                    axisLabel: {
                        rotate: 50
                    },
                },
                yAxis: {
                    type: 'value'
                },
                grid: { containLabel: true },
                color: color_set,
                series: [{
                    data: values,
                    type: 'bar'
                }]
            }; 

            current_echart.setOption(option);
            CHARTS_LIST.push(current_echart)
        }
    
    </script>
</body>